<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Farm2Home - The premier marketplace connecting local farmers directly with consumers and delivery partners. Fresh, Organic, Sustainable.">
    <meta name="theme-color" content="#047857">
    <title>Farm2Home - Fresh Produce Marketplace</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/726/726058.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        stone: {
                            50: '#fafaf9',
                            100: '#f5f5f4',
                            200: '#e7e5e4',
                            300: '#d6d3d1',
                            400: '#a8a29e',
                            500: '#78716c',
                            600: '#57534e',
                            700: '#44403c',
                            800: '#292524',
                            900: '#1c1917',
                            950: '#0c0a09',
                        },
                        emerald: {
                            50: '#ecfdf5',
                            100: '#d1fae5',
                            200: '#a7f3d0',
                            300: '#6ee7b7',
                            400: '#34d399',
                            500: '#10b981',
                            600: '#059669',
                            700: '#047857',
                            800: '#065f46',
                            900: '#064e3b',
                            950: '#022c22',
                        },
                        // Added warm accent colors for alerts
                        amber: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            500: '#f59e0b',
                            600: '#d97706',
                            700: '#b45309',
                        },
                        red: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                        }
                    },
                    fontFamily: {
                        sans: ['Outfit', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                        display: ['Plus Jakarta Sans', 'ui-sans-serif', 'system-ui'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                        'slide-in-right': 'slideInRight 0.4s ease-out forwards',
                        'bounce-slight': 'bounce 3s infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'spin-slow': 'spin 3s linear infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        slideInRight: {
                            '0%': { transform: 'translateX(100%)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(16, 185, 129, 0.3)',
                    }
                }
            }
        }
    </script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Import Map for React & Firebase -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>
    
    <!-- Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --glass-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
        }

        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: #FDFCF8; 
            color: #1C1917; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            letter-spacing: -0.025em;
        }

        /* --- Component Classes --- */
        
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: var(--glass-border);
            box-shadow: var(--glass-shadow);
        }

        .better-box {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            border: 1px solid #F0FDF4; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .better-box:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.01);
            border-color: #86EFAC; 
        }

        /* Input Styling */
        .input-better {
            width: 100%;
            padding: 1rem 1.25rem;
            background-color: #FAFAF9; 
            border: 1px solid #E7E5E4; 
            border-radius: 1rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            color: #1C1917;
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .input-better:focus {
            background-color: white;
            border-color: #15803D; 
            box-shadow: 0 0 0 4px rgba(21, 128, 61, 0.1);
        }

        .input-better::placeholder {
            color: #A8A29E;
        }
        
        .input-error {
            border-color: #EF4444;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
        }

        /* Button Base Styles */
        .btn-base {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border-radius: 0.75rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .btn-base:active {
            transform: scale(0.98);
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #D6D3D1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #A8A29E;
        }

        /* Loading Dots Animation */
        .loader-dots::after {
            content: " .";
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: " ."; }
            40% { content: " .."; }
            60% { content: " ..."; }
            80%, 100% { content: ""; }
        }
    </style>
</head>
<body class="antialiased selection:bg-emerald-100 selection:text-emerald-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        /**
         * ==========================================================================================
         * FARM2HOME MARKETPLACE - FULL APPLICATION (PART 1: SETUP & UI LIBRARY)
         * ==========================================================================================
         */

        import React, { useState, useEffect, useMemo, createContext, useContext, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Leaf, Truck, ShieldCheck, Heart, Search, ShoppingCart, 
          User, ChevronRight, Menu, X, MapPin, Star, 
          Facebook, Twitter, Instagram, Upload, FileText, CheckCircle, 
          XCircle, AlertCircle, Package, DollarSign, Users, ClipboardList, 
          Loader2, QrCode, Image as ImageIcon, LayoutDashboard, Info, 
          Home, Mail, Trash2, Box, Edit2, AlertTriangle, Copy, Phone, 
          ExternalLink, Settings, Wallet, FileCheck, Bike, Headphones, RefreshCw, 
          Sprout, LogOut, Clock, Calendar, Plus, Minus, Store, Ban, 
          BarChart3, PieChart, TrendingUp, HelpCircle, Lock, ShoppingBag
        } from 'lucide-react';

        // --- 1. FIREBASE CONFIGURATION & INITIALIZATION ---
        import { initializeApp } from 'firebase/app';
        import { 
          getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
          signOut, onAuthStateChanged, deleteUser, signInAnonymously,
          updateProfile
        } from 'firebase/auth';
        import { 
          getFirestore, collection, addDoc, getDocs, doc, setDoc, 
          getDoc, updateDoc, onSnapshot, query, where, serverTimestamp, 
          limit, orderBy, deleteDoc, increment
        } from 'firebase/firestore';

        // Secure Firebase Configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCTV6gg2QXLHJMSGvOWIa-YDy5-PvrgeHk",
          authDomain: "farm2home-2f7ff.firebaseapp.com",
          projectId: "farm2home-2f7ff",
          storageBucket: "farm2home-2f7ff.firebasestorage.app",
          messagingSenderId: "656644623315",
          appId: "1:656644623315:web:0d59d865c82b5c9b4e7d26",
          measurementId: "G-XFQFK8Q9TZ"
        };

        // Initialize App Services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- 2. UTILITY FUNCTIONS ---

        // Firestore Helpers
        const getCollection = (name) => collection(db, name);
        const getDocRef = (colName, docId) => doc(db, colName, docId);
        
        // Image Upload Service
        const uploadToCloudinary = async (file) => {
          const formData = new FormData();
          formData.append("file", file);
          formData.append("upload_preset", "Farm2Home");

          try {
              const res = await fetch(
                "https://api.cloudinary.com/v1_1/drf5cbuzu/auto/upload",
                { method: "POST", body: formData }
              );

              if (!res.ok) throw new Error("Image upload failed. Please check your connection.");
              const data = await res.json();
              return data.secure_url;
          } catch (error) {
              console.error("Upload Error:", error);
              throw error;
          }
        };

        // Formatters
        const formatINR = (number) => {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                maximumFractionDigits: 0
            }).format(number);
        };

        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.seconds ? new Date(timestamp.seconds * 1000) : new Date(timestamp);
            return date.toLocaleDateString('en-IN', {
                day: 'numeric', month: 'short', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        };

        const MOD_EMAILS = ['aadityabillawa@gmail.com', 'zeyamalam@gmail.com'];

        // --- 3. UI COMPONENT LIBRARY (ATOMIC) ---

        /**
         * Generic Spinner Component
         */
        const Spinner = ({ size = "w-5 h-5", color = "text-current" }) => (
            <Loader2 className={`animate-spin ${size} ${color}`} />
        );

        /**
         * Enhanced Button Component
         */
        const Button = ({ 
            children, onClick, variant = 'primary', size = 'md', 
            className = '', disabled = false, type = 'button', icon: Icon, fullWidth = false
        }) => {
            const base = "font-bold rounded-xl transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2";
            
            const variants = {
                primary: "bg-emerald-700 text-white hover:bg-emerald-800 shadow-lg shadow-emerald-700/20",
                secondary: "bg-white text-stone-700 border border-stone-200 hover:bg-stone-50",
                outline: "bg-transparent border-2 border-emerald-600 text-emerald-700 hover:bg-emerald-50",
                danger: "bg-white text-red-600 border border-red-200 hover:bg-red-50",
                dangerSolid: "bg-red-600 text-white hover:bg-red-700 shadow-lg shadow-red-600/20",
                ghost: "bg-transparent text-stone-500 hover:text-stone-900 hover:bg-stone-100",
                dark: "bg-stone-900 text-white hover:bg-stone-800 shadow-lg"
            };

            const sizes = {
                sm: "px-3 py-1.5 text-xs",
                md: "px-6 py-3 text-sm",
                lg: "px-8 py-4 text-lg"
            };

            return (
                <button 
                    type={type} 
                    onClick={onClick} 
                    disabled={disabled} 
                    className={`${base} ${variants[variant]} ${sizes[size]} ${fullWidth ? 'w-full' : ''} ${className}`}
                >
                    {Icon && <Icon className={size === 'sm' ? "w-3 h-3" : "w-4 h-4"} />}
                    {children}
                </button>
            );
        };

        /**
         * Form Input Component
         */
        const Input = ({ label, error, icon: Icon, ...props }) => (
            <div className="w-full">
                {label && <label className="block text-xs font-bold text-stone-500 uppercase mb-1.5 ml-1">{label}</label>}
                <div className="relative">
                    {Icon && <Icon className="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-stone-400 pointer-events-none"/>}
                    <input 
                        className={`w-full ${Icon ? 'pl-10' : 'px-4'} py-3 rounded-xl bg-stone-50 border ${error ? 'border-red-300 ring-2 ring-red-100' : 'border-stone-200'} focus:bg-white focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10 transition-all outline-none text-stone-800 font-medium placeholder-stone-400`}
                        {...props}
                    />
                </div>
                {error && <p className="text-xs text-red-500 mt-1 ml-1 font-bold flex items-center gap-1"><AlertCircle className="w-3 h-3"/> {error}</p>}
            </div>
        );

        /**
         * Form Select Component
         */
        const Select = ({ label, options, ...props }) => (
            <div className="w-full">
                {label && <label className="block text-xs font-bold text-stone-500 uppercase mb-1.5 ml-1">{label}</label>}
                <div className="relative">
                    <select 
                        className="w-full px-4 py-3 rounded-xl bg-stone-50 border border-stone-200 focus:bg-white focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10 transition-all outline-none text-stone-800 font-medium appearance-none cursor-pointer"
                        {...props}
                    >
                        {options.map(opt => (
                            <option key={opt.value} value={opt.value}>{opt.label}</option>
                        ))}
                    </select>
                    <ChevronRight className="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-stone-400 rotate-90 pointer-events-none"/>
                </div>
            </div>
        );

        /**
         * Form Textarea Component
         */
        const Textarea = ({ label, ...props }) => (
            <div className="w-full">
                {label && <label className="block text-xs font-bold text-stone-500 uppercase mb-1.5 ml-1">{label}</label>}
                <textarea 
                    className="w-full px-4 py-3 rounded-xl bg-stone-50 border border-stone-200 focus:bg-white focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10 transition-all outline-none text-stone-800 font-medium resize-none min-h-[100px]"
                    {...props}
                />
            </div>
        );

        /**
         * Status Badge Component with Animation
         */
        const StatusBadge = ({ status }) => {
            const styles = {
                'pending': 'bg-amber-100 text-amber-800 border-amber-200',
                'active': 'bg-emerald-100 text-emerald-800 border-emerald-200',
                'approved': 'bg-emerald-100 text-emerald-800 border-emerald-200',
                'rejected': 'bg-red-100 text-red-800 border-red-200',
                'suspended': 'bg-stone-800 text-white border-stone-900',
                'Payment Review': 'bg-amber-100 text-amber-800 border-amber-200',
                'Payment Verified': 'bg-blue-100 text-blue-800 border-blue-200',
                'Payment Rejected': 'bg-red-100 text-red-800 border-red-200',
                'Confirmed by Farmer': 'bg-indigo-100 text-indigo-800 border-indigo-200',
                'Preparing': 'bg-indigo-100 text-indigo-800 border-indigo-200',
                'Ready for Pickup': 'bg-teal-100 text-teal-800 border-teal-200',
                'Out for Delivery': 'bg-purple-100 text-purple-800 border-purple-200',
                'Delivered': 'bg-green-100 text-green-800 border-green-200',
            };
            
            // Icon mapping
            let BadgeIcon = Info;
            if (status === 'Delivered' || status === 'approved' || status === 'Payment Verified') BadgeIcon = CheckCircle;
            if (status === 'Payment Review' || status === 'pending') BadgeIcon = Clock;
            if (status === 'Out for Delivery') BadgeIcon = Bike;
            if (status === 'rejected' || status === 'Payment Rejected') BadgeIcon = XCircle;

            return (
                <span className={`inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wide border ${styles[status] || 'bg-stone-100 text-stone-500'}`}>
                    <BadgeIcon className="w-3 h-3" />
                    {status}
                </span>
            );
        };

        /**
         * Notification Toast
         */
        const NotificationToast = ({ msg, type, onClose }) => (
            <div className={`fixed bottom-6 right-6 z-[100] px-6 py-4 rounded-2xl text-white font-bold shadow-2xl animate-in slide-in-from-bottom-10 fade-in duration-300 flex items-center gap-3 ${type === 'error' ? 'bg-red-600' : 'bg-emerald-700'}`}>
                {type === 'error' ? <AlertTriangle className="w-5 h-5"/> : <CheckCircle className="w-5 h-5"/>}
                <span className="text-sm tracking-wide">{msg}</span>
                <button onClick={onClose} className="ml-4 hover:bg-white/20 p-1 rounded-full transition-colors"><X className="w-4 h-4"/></button>
            </div>
        );

        /**
         * Reusable Modal Wrapper
         */
        const Modal = ({ isOpen, onClose, title, children, maxWidth = "max-w-md" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-stone-900/60 backdrop-blur-md animate-in fade-in duration-200" onClick={onClose}>
                    <div className={`bg-white rounded-[2rem] w-full ${maxWidth} shadow-2xl scale-100 animate-in zoom-in-95 duration-200 border border-stone-100 relative overflow-hidden flex flex-col max-h-[90vh]`} onClick={e => e.stopPropagation()}>
                        <div className="p-6 border-b border-stone-100 flex justify-between items-center bg-white sticky top-0 z-10">
                            <h3 className="text-2xl font-bold text-stone-900 tracking-tight">{title}</h3>
                            <button onClick={onClose} className="p-2 bg-stone-50 rounded-full hover:bg-stone-200 transition-colors"><X className="w-5 h-5 text-stone-500"/></button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        /**
         * Confirmation Modal Specific
         */
        const ConfirmDialog = ({ isOpen, title, message, onConfirm, onCancel, confirmText = "Confirm", isDangerous = false }) => {
            if (!isOpen) return null;
            return (
                <Modal isOpen={isOpen} onClose={onCancel} title={title}>
                    <div className="flex flex-col items-center text-center">
                        <div className={`w-16 h-16 rounded-full flex items-center justify-center mb-6 ${isDangerous ? 'bg-red-50 text-red-500' : 'bg-emerald-50 text-emerald-600'}`}>
                            {isDangerous ? <AlertTriangle className="w-8 h-8"/> : <Info className="w-8 h-8"/>}
                        </div>
                        <p className="text-stone-500 mb-8 leading-relaxed">{message}</p>
                        <div className="flex gap-3 w-full">
                            <Button variant="secondary" onClick={onCancel} className="flex-1">Cancel</Button>
                            <Button variant={isDangerous ? "dangerSolid" : "primary"} onClick={onConfirm} className="flex-1">{confirmText}</Button>
                        </div>
                    </div>
                </Modal>
            );
        };
// --- 4. STATE MANAGEMENT & CONTEXT ---

        /**
         * Global App Context
         * Manages Authentication, Shopping Cart, Notifications, and View Routing.
         */
        const AppContext = createContext();

        const AppProvider = ({ children }) => {
            const [currentUser, setCurrentUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [notification, setNotification] = useState(null);
            const [cart, setCart] = useState([]);
            const [view, setView] = useState(() => localStorage.getItem('farm2home_view') || 'home');
            const [authMode, setAuthMode] = useState('login'); // 'login' | 'signup'

            // --- Notification Logic ---
            const showNotification = useCallback((msg, type = 'success') => {
                setNotification({ msg, type });
                // Auto-dismiss after 4 seconds
                setTimeout(() => setNotification(null), 4000);
            }, []);

            // --- Authentication Logic ---
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        try {
                            const userDocRef = getDocRef("users", user.uid);
                            const userDoc = await getDoc(userDocRef);
                            
                            if (userDoc.exists()) {
                                const userData = userDoc.data();
                                
                                // Auto-promote specific emails to Admin for easy testing/setup
                                if (MOD_EMAILS.includes(user.email.toLowerCase()) && userData.role !== 'mod') {
                                    await updateDoc(userDocRef, { role: 'mod', status: 'active' });
                                    userData.role = 'mod';
                                }
                                
                                setCurrentUser({ uid: user.uid, ...userData });
                            } else {
                                // Fallback for users auth'd but without a DB doc (should rarely happen)
                                setCurrentUser({ uid: user.uid, role: 'unknown', name: user.email });
                            }
                        } catch (error) {
                            console.error("Error fetching user profile:", error);
                            showNotification("Error loading profile. Please refresh.", "error");
                        }
                    } else {
                        setCurrentUser(null);
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [showNotification]);

            // --- View Persistence ---
            useEffect(() => {
                localStorage.setItem('farm2home_view', view);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, [view]);

            // --- Cart Logic ---
            // Load cart from local storage on mount
            useEffect(() => {
                const savedCart = localStorage.getItem('farm2home_cart');
                if (savedCart) {
                    try {
                        setCart(JSON.parse(savedCart));
                    } catch (e) {
                        console.error("Failed to parse cart", e);
                    }
                }
            }, []);

            // Save cart to local storage on change
            useEffect(() => {
                localStorage.setItem('farm2home_cart', JSON.stringify(cart));
            }, [cart]);

            const addToCart = (product) => {
                if (!currentUser) {
                    showNotification("Please login to start shopping.", "error");
                    setView('auth');
                    setAuthMode('login');
                    return;
                }
                
                if (product.stock <= 0) {
                    showNotification("Sorry, this item is out of stock.", "error");
                    return;
                }

                setCart(prev => {
                    const existingItem = prev.find(item => item.id === product.id);
                    if (existingItem) {
                        if (existingItem.quantity >= product.stock) {
                            showNotification(`Only ${product.stock} units available.`, "error");
                            return prev;
                        }
                        showNotification(`${product.name} quantity updated.`, "success");
                        return prev.map(item => 
                            item.id === product.id 
                                ? { ...item, quantity: item.quantity + 1 } 
                                : item
                        );
                    }
                    showNotification(`${product.name} added to cart.`, "success");
                    return [...prev, { ...product, quantity: 1 }];
                });
            };

            const removeFromCart = (productId) => {
                setCart(prev => prev.filter(item => item.id !== productId));
                showNotification("Item removed from basket.", "success");
            };

            const updateCartQuantity = (productId, delta) => {
                setCart(prev => prev.map(item => {
                    if (item.id === productId) {
                        const newQuantity = Math.max(0, item.quantity + delta);
                        // If quantity becomes 0, we'll filter it out later or handle removal explicitly
                        // Here we just return the new quantity logic
                        if (newQuantity === 0) return null;
                        if (newQuantity > item.stock) {
                            showNotification("Cannot exceed available stock.", "error");
                            return item;
                        }
                        return { ...item, quantity: newQuantity };
                    }
                    return item;
                }).filter(Boolean)); // Remove nulls
            };

            const clearCart = () => setCart([]);

            const handleLogout = async () => {
                try {
                    await signOut(auth);
                    setCart([]); // Optional: clear cart on logout
                    localStorage.removeItem('farm2home_view');
                    setView('home');
                    showNotification("Successfully logged out.", "success");
                } catch (error) {
                    console.error("Logout Error:", error);
                }
            };

            const value = {
                currentUser,
                loading,
                notification,
                showNotification,
                view,
                setView,
                authMode,
                setAuthMode,
                cart,
                addToCart,
                removeFromCart,
                updateCartQuantity,
                clearCart,
                handleLogout
            };

            return (
                <AppContext.Provider value={value}>
                    {children}
                    {notification && (
                        <NotificationToast 
                            msg={notification.msg} 
                            type={notification.type} 
                            onClose={() => setNotification(null)} 
                        />
                    )}
                </AppContext.Provider>
            );
        };

        const useGlobalState = () => useContext(AppContext);

        // --- 5. CORE LAYOUT COMPONENTS ---

        /**
         * Navigation Bar
         * Responsive, role-aware navigation that adapts to the user's state.
         */
        const Navbar = () => {
            const { currentUser, view, setView, handleLogout, setAuthMode } = useGlobalState();
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [scrolled, setScrolled] = useState(false);

            // Handle scroll effect for glassmorphism
            useEffect(() => {
                const handleScroll = () => setScrolled(window.scrollY > 20);
                window.addEventListener('scroll', handleScroll);
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            const NavButton = ({ target, label, icon: Icon }) => (
                <button 
                    onClick={() => { setView(target); setIsMenuOpen(false); }}
                    className={`flex items-center gap-2 px-4 py-2 rounded-xl transition-all duration-200 ${
                        view === target 
                            ? 'bg-emerald-50 text-emerald-700 font-bold' 
                            : 'text-stone-500 hover:bg-stone-50 hover:text-stone-900 font-medium'
                    }`}
                >
                    {Icon && <Icon className="w-4 h-4" />}
                    {label}
                </button>
            );

            return (
                <nav className={`fixed top-0 left-0 right-0 z-50 transition-all duration-300 ${scrolled ? 'bg-white/90 backdrop-blur-xl shadow-sm h-16' : 'bg-transparent h-24'}`}>
                    <div className="max-w-7xl mx-auto px-4 h-full flex justify-between items-center">
                        {/* Logo */}
                        <div 
                            className="flex items-center gap-3 cursor-pointer group" 
                            onClick={() => setView('home')}
                        >
                            <div className="bg-gradient-to-br from-emerald-600 to-teal-500 p-2.5 rounded-xl shadow-lg shadow-emerald-500/20 group-hover:scale-105 transition-transform duration-300">
                                <Leaf className="text-white w-6 h-6" />
                            </div>
                            <div className="flex flex-col">
                                <span className="text-2xl font-bold text-stone-800 tracking-tight leading-none">
                                    Farm<span className="text-emerald-600">2</span>Home
                                </span>
                                <span className="text-[10px] font-bold text-stone-400 uppercase tracking-widest leading-none mt-0.5">
                                    Fresh Market
                                </span>
                            </div>
                        </div>

                        {/* Desktop Menu */}
                        <div className="hidden md:flex items-center gap-2">
                            <NavButton target="home" label="Home" />
                            <NavButton target="marketplace" label="Shop" />
                            <NavButton target="about" label="Our Story" />
                        </div>

                        {/* Desktop Auth/User Menu */}
                        <div className="hidden md:flex items-center gap-4">
                            {!currentUser ? (
                                <div className="flex items-center gap-3">
                                    <button 
                                        onClick={() => { setView('auth'); setAuthMode('login'); }}
                                        className="text-stone-600 font-bold hover:text-emerald-700 px-4 py-2 transition-colors"
                                    >
                                        Sign In
                                    </button>
                                    <Button 
                                        onClick={() => { setView('auth'); setAuthMode('signup'); }}
                                        variant="primary"
                                        size="md"
                                        className="shadow-emerald-500/25"
                                    >
                                        Get Started
                                    </Button>
                                </div>
                            ) : (
                                <div className="flex items-center gap-3">
                                    {/* Role Specific Buttons */}
                                    {currentUser.role === 'farmer' && (
                                        <Button 
                                            variant="primary" 
                                            size="sm" 
                                            onClick={() => setView('farmer-panel')}
                                            icon={LayoutDashboard}
                                            className="bg-emerald-100 text-emerald-800 hover:bg-emerald-200 border border-emerald-200 shadow-none"
                                        >
                                            Farmer Dashboard
                                        </Button>
                                    )}
                                    {currentUser.role === 'delivery' && (
                                        <Button 
                                            variant="primary" 
                                            size="sm" 
                                            onClick={() => setView('delivery-panel')}
                                            icon={Bike}
                                            className="bg-orange-100 text-orange-800 hover:bg-orange-200 border border-orange-200 shadow-none"
                                        >
                                            Delivery Panel
                                        </Button>
                                    )}
                                    {currentUser.role === 'mod' && (
                                        <Button 
                                            variant="primary" 
                                            size="sm" 
                                            onClick={() => setView('mod-panel')}
                                            icon={ShieldCheck}
                                            className="bg-purple-100 text-purple-800 hover:bg-purple-200 border border-purple-200 shadow-none"
                                        >
                                            Admin
                                        </Button>
                                    )}

                                    {/* Universal My Purchases */}
                                    <Button 
                                        variant="secondary" 
                                        size="sm" 
                                        onClick={() => setView('my-orders')}
                                        icon={Package}
                                    >
                                        My Orders
                                    </Button>

                                    <div className="h-8 w-px bg-stone-200 mx-2"></div>

                                    {/* Profile Dropdown Trigger */}
                                    <div className="flex items-center gap-3 group relative">
                                        <div className="text-right hidden lg:block">
                                            <p className="text-sm font-bold text-stone-900 leading-none">{currentUser.name.split(' ')[0]}</p>
                                            <p className="text-[10px] font-bold text-stone-400 uppercase leading-none mt-1">{currentUser.role}</p>
                                        </div>
                                        <div className="w-10 h-10 rounded-full bg-gradient-to-tr from-stone-800 to-stone-700 text-white flex items-center justify-center font-bold shadow-md ring-2 ring-white cursor-pointer hover:ring-emerald-200 transition-all">
                                            {currentUser.name ? currentUser.name.charAt(0).toUpperCase() : <User className="w-5 h-5"/>}
                                        </div>
                                        
                                        {/* Dropdown Menu (Hover) */}
                                        <div className="absolute right-0 top-full mt-2 w-48 bg-white rounded-xl shadow-xl border border-stone-100 p-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all transform translate-y-2 group-hover:translate-y-0">
                                            <button onClick={handleLogout} className="w-full text-left px-4 py-2 rounded-lg text-sm font-bold text-red-600 hover:bg-red-50 flex items-center gap-2">
                                                <LogOut className="w-4 h-4"/> Sign Out
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Mobile Menu Toggle */}
                        <button className="md:hidden text-stone-800 p-2" onClick={() => setIsMenuOpen(!isMenuOpen)}>
                            {isMenuOpen ? <X /> : <Menu />}
                        </button>
                    </div>

                    {/* Mobile Menu Overlay */}
                    {isMenuOpen && (
                        <div className="absolute top-full left-0 right-0 bg-white border-b border-stone-100 p-4 shadow-xl md:hidden flex flex-col gap-2 animate-slide-up">
                            <NavButton target="home" label="Home" icon={Home}/>
                            <NavButton target="marketplace" label="Shop Produce" icon={Store}/>
                            <NavButton target="about" label="Our Mission" icon={Info}/>
                            <div className="h-px bg-stone-100 my-2"></div>
                            {currentUser ? (
                                <>
                                    {currentUser.role === 'farmer' && <NavButton target="farmer-panel" label="Farmer Dashboard" icon={LayoutDashboard}/>}
                                    {currentUser.role === 'delivery' && <NavButton target="delivery-panel" label="Delivery Panel" icon={Bike}/>}
                                    {currentUser.role === 'mod' && <NavButton target="mod-panel" label="Admin Console" icon={ShieldCheck}/>}
                                    <NavButton target="my-orders" label="My Purchases" icon={Package}/>
                                    <button onClick={handleLogout} className="flex items-center gap-2 px-4 py-3 rounded-xl bg-red-50 text-red-600 font-bold text-sm">
                                        <LogOut className="w-4 h-4"/> Sign Out
                                    </button>
                                </>
                            ) : (
                                <div className="flex flex-col gap-2">
                                    <Button onClick={() => { setView('auth'); setAuthMode('login'); setIsMenuOpen(false); }} variant="secondary" fullWidth>Sign In</Button>
                                    <Button onClick={() => { setView('auth'); setAuthMode('signup'); setIsMenuOpen(false); }} variant="primary" fullWidth>Create Account</Button>
                                </div>
                            )}
                        </div>
                    )}
                </nav>
            );
        };

        /**
         * Footer Component
         * Informational footer with links and social proofs.
         */
        const Footer = () => {
            const { setView, setAuthMode } = useGlobalState();
            
            const FooterLink = ({ label, onClick }) => (
                <li>
                    <button onClick={onClick} className="text-stone-400 hover:text-emerald-400 transition-colors text-sm text-left">
                        {label}
                    </button>
                </li>
            );

            return (
                <footer className="bg-stone-900 text-stone-400 py-20 mt-auto border-t border-stone-800">
                    <div className="max-w-7xl mx-auto px-4">
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-12 mb-16">
                            {/* Brand Column */}
                            <div className="col-span-1 md:col-span-2">
                                <div className="flex items-center gap-2 mb-6 text-white">
                                    <div className="bg-emerald-900/50 p-2 rounded-lg border border-emerald-800">
                                        <Leaf className="text-emerald-500 w-6 h-6" />
                                    </div>
                                    <span className="text-2xl font-bold">Farm<span className="text-emerald-500">2</span>Home</span>
                                </div>
                                <p className="leading-relaxed mb-8 max-w-sm text-stone-400 text-sm">
                                    Bridging the gap between the earth's bounty and your dining table. 
                                    We ensure fair prices for farmers, efficient routes for drivers, and the freshest produce for your family.
                                </p>
                                <div className="flex gap-4">
                                    {['Facebook', 'Twitter', 'Instagram'].map(social => (
                                        <button key={social} className="w-10 h-10 rounded-full bg-stone-800 flex items-center justify-center text-stone-400 hover:bg-emerald-600 hover:text-white transition-all transform hover:-translate-y-1">
                                            {social === 'Facebook' && <Facebook className="w-5 h-5"/>}
                                            {social === 'Twitter' && <Twitter className="w-5 h-5"/>}
                                            {social === 'Instagram' && <Instagram className="w-5 h-5"/>}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Platform Links */}
                            <div>
                                <h4 className="font-bold text-white mb-6 uppercase tracking-wider text-xs">Platform</h4>
                                <ul className="space-y-3">
                                    <FooterLink label="Home" onClick={() => setView('home')} />
                                    <FooterLink label="Shop Produce" onClick={() => setView('marketplace')} />
                                    <FooterLink label="Our Mission" onClick={() => setView('about')} />
                                    <li className="pt-2"><span className="text-xs font-bold text-stone-600 uppercase">Join Us</span></li>
                                    <FooterLink label="Become a Farmer" onClick={() => { setView('auth'); setAuthMode('signup'); }} />
                                    <FooterLink label="Become a Delivery Partner" onClick={() => { setView('auth'); setAuthMode('signup'); }} />
                                </ul>
                            </div>

                            {/* Support Links */}
                            <div>
                                <h4 className="font-bold text-white mb-6 uppercase tracking-wider text-xs">Support</h4>
                                <ul className="space-y-3">
                                    <FooterLink label="Help Center" onClick={() => {}} />
                                    <FooterLink label="Refund Policy" onClick={() => {}} />
                                    <FooterLink label="Shipping Policy" onClick={() => {}} />
                                    <FooterLink label="Terms of Service" onClick={() => {}} />
                                    <li className="pt-4">
                                        <a href="mailto:farm2home@support.in" className="flex items-center gap-2 text-emerald-500 font-bold hover:text-emerald-400 transition-colors">
                                            <Mail className="w-4 h-4"/> farm2home@support.in
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        {/* Copyright */}
                        <div className="border-t border-stone-800 pt-8 flex flex-col md:flex-row justify-between items-center gap-4 text-xs">
                            <p>&copy; {new Date().getFullYear()} Farm2Home Technologies Inc. All rights reserved.</p>
                            <div className="flex items-center gap-6">
                                <a href="#" className="hover:text-white transition-colors">Privacy</a>
                                <a href="#" className="hover:text-white transition-colors">Terms</a>
                                <a href="#" className="hover:text-white transition-colors">Cookies</a>
                            </div>
                            <p className="flex items-center gap-1 opacity-60">Made with <Heart className="w-3 h-3 text-red-500 fill-red-500"/> for a Greener Earth.</p>
                        </div>
                    </div>
                </footer>
            );
        };

        // --- 6. AUTHENTICATION COMPONENT ---

        const AuthScreen = ({ authMode, setAuthMode, handleLogin, handleSignup, loading }) => {
             const [role, setRole] = useState('buyer'); 
             const [file, setFile] = useState(null);
             const [formData, setFormData] = useState({ 
                 name: '', email: '', password: '', phone: '', address: '', 
                 aadhar: '', vehicleName: '', vehicleNumber: '' 
             });
             
             // Handle Form Submission
             const handleSubmit = (e) => {
               e.preventDefault();
               if (authMode === 'login') {
                   handleLogin(formData.email, formData.password);
               } else {
                   handleSignup({ ...formData, role }, file);
               }
             };

             return (
               <div className="min-h-screen pt-20 flex bg-[#FDFCF8]">
                 {/* Left Side - Visuals */}
                 <div className="hidden lg:flex w-1/2 bg-stone-900 relative items-center justify-center overflow-hidden">
                    <div className="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1500937386664-56d1dfef3854?q=80&w=1740')] bg-cover bg-center opacity-60 mix-blend-overlay"></div>
                    <div className="absolute inset-0 bg-gradient-to-t from-stone-900/90 to-transparent"></div>
                    <div className="relative z-10 p-16 text-white max-w-2xl">
                        <div className="inline-flex items-center gap-2 bg-emerald-500/20 backdrop-blur-md px-4 py-2 rounded-full border border-emerald-500/30 mb-8 animate-in slide-in-from-left-4 duration-700 delay-100">
                            <Sprout className="w-5 h-5 text-emerald-400" />
                            <span className="font-bold tracking-wide text-sm text-emerald-50">Direct From Soil</span>
                        </div>
                        <h1 className="text-6xl font-display font-bold mb-6 leading-tight animate-in slide-in-from-left-4 duration-700 delay-200">The Future of <span className="text-emerald-400">Food</span> is Local.</h1>
                        <p className="text-xl text-stone-300 leading-relaxed max-w-lg font-light animate-in slide-in-from-left-4 duration-700 delay-300">
                            Join a thriving ecosystem where farmers get fair value, drivers earn flexibly, and families get the purest nutrition.
                        </p>
                    </div>
                 </div>
                 
                 {/* Right Side - Form */}
                 <div className="w-full lg:w-1/2 flex items-center justify-center p-8 lg:p-16 overflow-y-auto">
                   <div className="w-full max-w-md animate-in slide-in-from-right-10 duration-500">
                       <div className="mb-10 text-center lg:text-left">
                           <h2 className="text-4xl font-bold text-stone-900 mb-3 font-display">
                               {authMode === 'login' ? 'Welcome Back' : 'Join the Movement'}
                           </h2>
                           <p className="text-stone-500">Access the freshest marketplace today.</p>
                       </div>

                       <form onSubmit={handleSubmit} className="space-y-6">
                         {/* Role Selection Toggle (Signup Only) */}
                         {authMode === 'signup' && (
                           <div className="grid grid-cols-3 gap-2 p-1.5 bg-stone-100 rounded-2xl mb-6">
                               {['buyer', 'farmer', 'delivery'].map((r) => (
                                   <button 
                                      key={r}
                                      type="button" // CRITICAL: Prevent form submission
                                      onClick={() => setRole(r)} 
                                      className={`py-3 text-xs font-bold rounded-xl capitalize transition-all duration-300 ${role === r ? 'bg-white text-emerald-700 shadow-sm ring-1 ring-black/5' : 'text-stone-500 hover:text-stone-700'}`}
                                   >
                                       {r === 'delivery' ? 'Driver' : r}
                                   </button>
                               ))}
                           </div>
                         )}
                         
                         {/* Signup Fields */}
                         {authMode === 'signup' && (
                             <div className="space-y-4 animate-in fade-in">
                                 <Input 
                                    required 
                                    placeholder="Full Name" 
                                    value={formData.name} 
                                    onChange={e => setFormData({...formData, name: e.target.value})} 
                                 />
                                 
                                 <div className="relative">
                                     <div className="absolute left-4 top-1/2 -translate-y-1/2 font-bold text-stone-400 border-r border-stone-200 pr-3 text-sm select-none pointer-events-none">+91</div>
                                     <input 
                                        required 
                                        placeholder="Mobile Number" 
                                        className="input-better pl-16" 
                                        value={formData.phone} 
                                        maxLength={10} 
                                        onChange={e => {
                                            const val = e.target.value.replace(/\D/g, '').slice(0, 10);
                                            setFormData({...formData, phone: val});
                                        }} 
                                     />
                                 </div>
                                 
                                 {role === 'farmer' && (
                                     <Input 
                                        required 
                                        placeholder="Farm Location / Address" 
                                        value={formData.address} 
                                        onChange={e => setFormData({...formData, address: e.target.value})} 
                                     />
                                 )}
                                 
                                 {/* Delivery Specific Fields */}
                                 {role === 'delivery' && (
                                     <div className="grid grid-cols-2 gap-4 animate-in fade-in">
                                        <Input 
                                            required 
                                            placeholder="Vehicle Name" 
                                            value={formData.vehicleName} 
                                            onChange={e => setFormData({...formData, vehicleName: e.target.value})} 
                                        />
                                        <Input 
                                            required 
                                            placeholder="Vehicle Number" 
                                            value={formData.vehicleNumber} 
                                            onChange={e => setFormData({...formData, vehicleNumber: e.target.value})} 
                                        />
                                     </div>
                                 )}
                             </div>
                         )}

                         {/* Common Fields */}
                         <div className="space-y-4">
                             <Input 
                                required 
                                type="email" 
                                placeholder="Email Address" 
                                value={formData.email} 
                                onChange={e => setFormData({...formData, email: e.target.value})} 
                             />
                             <Input 
                                required 
                                type="password" 
                                placeholder="Password" 
                                value={formData.password} 
                                onChange={e => setFormData({...formData, password: e.target.value})} 
                             />
                         </div>

                         {/* Verification Section */}
                         {authMode === 'signup' && (role === 'farmer' || role === 'delivery') && (
                             <div className="bg-emerald-50/50 p-6 rounded-3xl border border-emerald-100 space-y-4 mt-4 animate-in fade-in">
                                 <div className="flex items-center gap-2 text-emerald-800 font-bold text-sm uppercase tracking-wide">
                                     <ShieldCheck className="w-4 h-4" /> Identity Verification
                                 </div>
                                 
                                 <Input 
                                    required 
                                    placeholder="Aadhar Number" 
                                    className="bg-white" 
                                    value={formData.aadhar} 
                                    onChange={e => setFormData({...formData, aadhar: e.target.value})} 
                                 />
                                 
                                 <div className="border-2 border-dashed border-emerald-200 p-6 text-center rounded-2xl cursor-pointer relative hover:bg-emerald-50 transition-colors group bg-white/50">
                                     <Upload className="w-8 h-8 text-emerald-400 mx-auto mb-2 group-hover:scale-110 transition-transform"/>
                                     <span className="text-sm font-bold text-stone-600 block">{file ? file.name : "Upload Government ID"}</span>
                                     <p className="text-xs text-stone-400 mt-1">Supported formats: JPG, PNG, PDF</p>
                                     <input 
                                        type="file" 
                                        className="absolute inset-0 opacity-0 cursor-pointer" 
                                        onChange={e => setFile(e.target.files[0])} 
                                     />
                                 </div>
                             </div>
                         )}

                         <Button 
                            type="submit" 
                            variant="primary" 
                            size="lg" 
                            className="w-full mt-6 text-lg"
                            disabled={loading}
                         >
                             {loading ? <Spinner className="text-white"/> : (authMode === 'login' ? 'Sign In' : 'Create Account')}
                         </Button>
                       </form>

                       <div className="mt-8 text-center">
                           <button 
                                onClick={() => setAuthMode(authMode === 'login' ? 'signup' : 'login')} 
                                className="text-stone-500 font-medium hover:text-emerald-700 transition-colors"
                            >
                               {authMode === 'login' ? "New to Farm2Home? Create an Account" : "Already a member? Sign In"}
                           </button>
                       </div>
                   </div>
                 </div>
               </div>
             );
        };
// --- 6. FEATURE COMPONENTS: BUYER DASHBOARD & CHECKOUT ---

        /**
         * Buyer Orders Component
         * Shows history of purchases with detailed status tracking.
         */
        const BuyerOrders = () => {
            const { currentUser, setView } = useGlobalState();
            const [orders, setOrders] = useState([]);
            const [loadingOrders, setLoadingOrders] = useState(true);

            useEffect(() => {
                if (!currentUser) return;

                const q = query(getCollection("orders"), where("customerId", "==", currentUser.uid));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Sort by newest first (client-side sort for robustness)
                    items.sort((a, b) => {
                        const timeA = a.createdAt?.seconds || 0;
                        const timeB = b.createdAt?.seconds || 0;
                        return timeB - timeA;
                    });
                    setOrders(items);
                    setLoadingOrders(false);
                }, (error) => {
                    console.error("Error fetching buyer orders:", error);
                    setLoadingOrders(false);
                });

                return () => unsubscribe();
            }, [currentUser]);

            if (loadingOrders) return (
                <div className="min-h-screen pt-28 flex justify-center">
                    <Spinner size="w-8 h-8" color="text-emerald-600"/>
                </div>
            );

            return (
                <div className="min-h-screen pt-28 pb-12 px-4 bg-stone-50 animate-in fade-in">
                    <div className="max-w-4xl mx-auto">
                        <div className="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
                            <div>
                                <h1 className="text-4xl font-display font-black text-stone-900 tracking-tight">My Purchases</h1>
                                <p className="text-stone-500 mt-2">Track your fresh deliveries from farm to door.</p>
                            </div>
                            <Button onClick={() => setView('marketplace')} variant="primary" icon={Store} className="shadow-lg">
                                Browse Shop
                            </Button>
                        </div>
                        
                        <div className="space-y-6">
                            {orders.length === 0 && (
                                <div className="text-center py-24 bg-white rounded-[2rem] border border-dashed border-stone-200 shadow-sm flex flex-col items-center">
                                    <div className="w-20 h-20 bg-stone-50 rounded-full flex items-center justify-center mb-6 text-stone-300">
                                        <Package className="w-10 h-10"/>
                                    </div>
                                    <h3 className="text-xl font-bold text-stone-800 mb-2">No orders yet</h3>
                                    <p className="text-stone-500 font-medium mb-8 max-w-xs mx-auto">Your kitchen looks a bit empty! Start shopping for fresh, organic produce today.</p>
                                    <Button onClick={() => setView('marketplace')} variant="secondary">Start Shopping</Button>
                                </div>
                            )}

                            {orders.map(order => (
                                <div key={order.id} className="better-box p-0 bg-white relative overflow-hidden group">
                                    {/* Order Header */}
                                    <div className="p-6 md:p-8 border-b border-stone-100 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-white z-10 relative">
                                        <div>
                                            <div className="flex items-center gap-3 mb-2">
                                                <h3 className="font-bold text-xl text-stone-900">Order #{order.id.slice(0,6).toUpperCase()}</h3>
                                                <StatusBadge status={order.status}/>
                                            </div>
                                            <p className="text-xs text-stone-400 font-mono flex items-center gap-2">
                                                <Calendar className="w-3 h-3"/>
                                                {formatDate(order.createdAt)}
                                            </p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-xs font-bold text-stone-400 uppercase tracking-wide mb-1">Total Paid</p>
                                            <p className="text-2xl font-black text-stone-900">{formatINR(order.total)}</p>
                                        </div>
                                    </div>
                                    
                                    {/* Notifications within Order Card */}
                                    {order.status === 'Payment Verified' && (
                                        <div className="mx-6 md:mx-8 mt-6 bg-emerald-50 border border-emerald-100 text-emerald-800 p-4 rounded-2xl text-sm font-bold flex items-start gap-3 shadow-sm">
                                            <div className="bg-white p-1.5 rounded-full shadow-sm"><CheckCircle className="w-5 h-5 text-emerald-600"/></div>
                                            <div>
                                                <p className="mb-0.5">Order Confirmed!</p>
                                                <p className="font-medium text-xs opacity-80">Payment verified by Admin. The farmer is now preparing your fresh package.</p>
                                            </div>
                                        </div>
                                    )}

                                    {order.status === 'Payment Rejected' && (
                                        <div className="mx-6 md:mx-8 mt-6 bg-red-50 border border-red-100 text-red-800 p-4 rounded-2xl text-sm font-bold flex items-start gap-3 shadow-sm">
                                            <div className="bg-white p-1.5 rounded-full shadow-sm"><XCircle className="w-5 h-5 text-red-600"/></div>
                                            <div>
                                                <p className="mb-0.5">Payment Rejected</p>
                                                <p className="font-medium text-xs opacity-80">There was an issue verifying your payment. Please contact support with Order ID #{order.id.slice(0,6)}.</p>
                                            </div>
                                        </div>
                                    )}

                                    {/* Order Content */}
                                    <div className="p-6 md:p-8 grid md:grid-cols-2 gap-8 md:gap-12">
                                        <div className="space-y-4">
                                            <h4 className="font-bold text-stone-900 text-xs uppercase tracking-wider flex items-center gap-2">
                                                <ShoppingBag className="w-3 h-3"/> Items Ordered
                                            </h4>
                                            <div className="space-y-3">
                                                {(order.items || []).map((item, idx) => (
                                                    <div key={idx} className="flex justify-between items-center text-sm p-3 bg-stone-50 rounded-xl hover:bg-stone-100 transition-colors">
                                                        <div className="flex flex-col">
                                                            <span className="font-bold text-stone-800">{item.name}</span>
                                                            <span className="text-stone-500 text-xs">Qty: {item.quantity} {item.unit}</span>
                                                        </div>
                                                        <span className="font-bold text-stone-900">{formatINR(item.price * item.quantity)}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        
                                        <div className="space-y-4">
                                            <h4 className="font-bold text-stone-900 text-xs uppercase tracking-wider flex items-center gap-2">
                                                <Truck className="w-3 h-3"/> Delivery Info
                                            </h4>
                                            <div className="bg-stone-50 p-5 rounded-2xl space-y-4 text-sm text-stone-600 border border-stone-100">
                                                <div className="flex items-start gap-3">
                                                    <div className="w-8 h-8 rounded-full bg-white border border-stone-200 flex items-center justify-center shrink-0 shadow-sm"><MapPin className="w-4 h-4 text-emerald-600"/></div> 
                                                    <div>
                                                        <p className="font-bold text-stone-900 text-xs uppercase mb-1">Shipping Address</p>
                                                        <p className="leading-snug">{order.delivery?.address}</p>
                                                        <p className="leading-snug text-stone-400 mt-1">{order.delivery?.state}, {order.delivery?.zip}</p>
                                                    </div>
                                                </div>
                                                <div className="h-px bg-stone-200 w-full"></div>
                                                <div className="flex items-center gap-3">
                                                    <div className="w-8 h-8 rounded-full bg-white border border-stone-200 flex items-center justify-center shrink-0 shadow-sm"><Phone className="w-4 h-4 text-emerald-600"/></div>
                                                    <div>
                                                        <p className="font-bold text-stone-900 text-xs uppercase mb-1">Contact</p>
                                                        <p className="font-mono">{order.delivery?.phone}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Progress Bar Visual */}
                                    <div className="h-1.5 w-full bg-stone-100 mt-auto">
                                        <div 
                                            className={`h-full transition-all duration-1000 ease-out ${
                                                order.status === 'Delivered' ? 'bg-emerald-500 w-full' :
                                                order.status === 'Out for Delivery' ? 'bg-purple-500 w-3/4' :
                                                order.status === 'Ready for Pickup' ? 'bg-teal-500 w-1/2' :
                                                order.status === 'Preparing' ? 'bg-indigo-500 w-1/3' :
                                                order.status === 'Payment Verified' ? 'bg-blue-500 w-1/4' :
                                                'bg-amber-400 w-1/12'
                                            }`}
                                        ></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        /**
         * Checkout Modal Component
         * Handles delivery info input and payment proof upload.
         */
        const CheckoutModal = ({ onClose, onConfirm }) => {
             const { cart, currentUser, showNotification } = useGlobalState();
             const [uploading, setUploading] = useState(false);
             const [error, setError] = useState(""); 
             const [screenshot, setScreenshot] = useState(null);
             const [adminPaymentSettings, setAdminPaymentSettings] = useState(null);
             
             // Form State
             const [delivery, setDelivery] = useState({ 
                 name: currentUser?.name || '', 
                 email: currentUser?.email || '', 
                 phone: currentUser?.phone || '', 
                 address: currentUser?.address || '', 
                 state: '', 
                 zip: '' 
             });

             // Load Admin Payment Settings (QR Code)
             useEffect(() => {
                const fetchSettings = async () => {
                    try {
                        const snap = await getDoc(getDocRef("settings", "payment"));
                        if (snap.exists()) setAdminPaymentSettings(snap.data());
                    } catch(e) {
                        console.error("Failed to load payment settings", e);
                    }
                };
                fetchSettings();
             }, []);

             // Calculations
             const subtotal = useMemo(() => cart.reduce((sum, i) => sum + (i.price * i.quantity), 0), [cart]);
             const deliveryFee = 60;
             const grandTotal = subtotal + deliveryFee;

             const handleConfirm = async () => {
                 if (!screenshot) return setError("Please upload the payment screenshot to proceed.");
                 if (!delivery.address || !delivery.phone || !delivery.zip) return setError("Please fill in all shipping details.");
                 
                 setUploading(true);
                 setError("");
                 
                 try {
                     const ssUrl = await uploadToCloudinary(screenshot);
                     
                     // Group items by farmer ID to create split orders if multiple vendors
                     const groups = {};
                     cart.forEach(item => { 
                         if (!groups[item.farmerId]) groups[item.farmerId] = []; 
                         groups[item.farmerId].push(item); 
                     });

                     const batchPromises = Object.keys(groups).map(async (farmerId) => {
                         const items = groups[farmerId];
                         const portionTotal = items.reduce((s, i) => s + (i.price * i.quantity), 0);
                         
                         // Create Order Document
                         return addDoc(getCollection("orders"), { 
                             farmerId, 
                             customerId: currentUser.uid, 
                             delivery, 
                             items, 
                             subtotal: portionTotal, 
                             // We store the grand total of this specific sub-order (pro-rated delivery fee logic could go here, keeping simple for now)
                             total: portionTotal, 
                             screenshotUrl: ssUrl, 
                             status: 'Payment Review', 
                             createdAt: serverTimestamp(),
                             grandTotalPaid: grandTotal // Reference for admin to see total amount user paid
                         });
                     });

                     await Promise.all(batchPromises);
                     
                     showNotification("Order placed successfully! You can track it in 'My Purchases'.", "success");
                     onConfirm(); // Clears cart via parent
                     onClose();   // Closes modal
                     
                 } catch (e) { 
                     console.error("Checkout Error:", e);
                     setError("Failed to place order. Please try again."); 
                 } finally { 
                     setUploading(false); 
                 }
             };

             return (
                 <Modal isOpen={true} onClose={onClose} title="Secure Checkout" maxWidth="max-w-5xl">
                     <div className="flex flex-col lg:flex-row gap-8">
                         
                         {/* LEFT COL: Shipping Form */}
                         <div className="flex-1 space-y-6">
                            <div className="flex items-center gap-2 mb-2">
                                <span className="bg-stone-900 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold">1</span>
                                <h4 className="text-sm font-bold text-stone-900 uppercase tracking-wider">Shipping Details</h4>
                            </div>
                            
                            {error && (
                                <div className="bg-red-50 text-red-600 p-4 rounded-xl text-sm font-bold flex items-center gap-3 border border-red-100 animate-pulse">
                                    <AlertTriangle className="w-5 h-5 shrink-0"/> 
                                    {error}
                                </div>
                            )}
                            
                            <Input 
                                label="Full Name" 
                                placeholder="Receiver Name" 
                                value={delivery.name} 
                                onChange={e => setDelivery({...delivery, name: e.target.value})} 
                            />
                            
                            <div>
                                <label className="block text-xs font-bold text-stone-500 uppercase mb-1.5 ml-1">Phone Number</label>
                                <div className="relative">
                                    <div className="absolute left-4 top-1/2 -translate-y-1/2 font-bold text-stone-400 border-r border-stone-200 pr-3 text-sm select-none pointer-events-none">+91</div>
                                    <input 
                                        className="input-better pl-16" 
                                        placeholder="9876543210" 
                                        value={delivery.phone} 
                                        maxLength={10} 
                                        onChange={e => {
                                            const val = e.target.value.replace(/\D/g, '').slice(0, 10);
                                            setDelivery({...delivery, phone: val});
                                        }} 
                                    />
                                </div>
                            </div>

                            <Input 
                                label="Street Address" 
                                placeholder="House No, Building, Area" 
                                value={delivery.address} 
                                onChange={e => setDelivery({...delivery, address: e.target.value})} 
                            />
                            
                            <div className="grid grid-cols-2 gap-4">
                                <Input label="State" placeholder="State" value={delivery.state} onChange={e => setDelivery({...delivery, state: e.target.value})} />
                                <Input label="Zip Code" placeholder="000000" value={delivery.zip} onChange={e => setDelivery({...delivery, zip: e.target.value})} />
                            </div>
                         </div>
                         
                         {/* RIGHT COL: Payment & Summary */}
                         <div className="w-full lg:w-96 bg-stone-50 p-8 rounded-[2rem] border border-stone-200 flex flex-col h-fit">
                             <div className="flex items-center gap-2 mb-6">
                                 <span className="bg-emerald-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold">2</span>
                                 <h3 className="font-bold text-lg text-stone-900 uppercase tracking-wider">Payment</h3>
                             </div>

                             <div className="space-y-3 mb-6 pb-6 border-b border-stone-200 text-sm">
                                 <div className="flex justify-between text-stone-600"><span>Subtotal</span><span>{formatINR(subtotal)}</span></div>
                                 <div className="flex justify-between text-stone-600"><span>Delivery Fee</span><span>{formatINR(deliveryFee)}</span></div>
                                 <div className="flex justify-between text-xl font-black text-emerald-800 pt-2"><span>Total</span><span>{formatINR(grandTotal)}</span></div>
                             </div>
                             
                             {adminPaymentSettings?.qrCodeUrl ? (
                                 <div className="text-center mb-6 bg-white p-4 rounded-2xl shadow-sm border border-stone-200">
                                     <p className="text-xs font-bold text-stone-400 uppercase mb-3">Scan to Pay</p>
                                     <img src={adminPaymentSettings.qrCodeUrl} className="w-48 h-48 object-contain mx-auto rounded-lg" alt="Payment QR" />
                                     {adminPaymentSettings.upiId && (
                                         <div className="mt-4 flex items-center justify-center gap-2 bg-stone-100 py-2 px-3 rounded-lg text-xs font-mono text-stone-600">
                                             {adminPaymentSettings.upiId} 
                                             <Copy className="w-3 h-3 cursor-pointer hover:text-emerald-600"/>
                                         </div>
                                     )}
                                 </div>
                             ) : (
                                 <div className="text-sm text-stone-400 text-center py-10 bg-white rounded-xl mb-6 border border-dashed border-stone-300 flex flex-col items-center gap-2">
                                     <AlertTriangle className="w-6 h-6 text-amber-400"/>
                                     <span>No QR Code Configured</span>
                                 </div>
                             )}
                             
                             <div className="mb-6">
                                 <label className="block text-xs font-bold text-stone-500 uppercase mb-2 ml-1">Upload Payment Screenshot</label>
                                 <div className="relative group">
                                     <div className="absolute inset-0 bg-emerald-50 rounded-xl opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                                     <input 
                                         type="file" 
                                         onChange={e => setScreenshot(e.target.files[0])} 
                                         className="block w-full text-sm text-stone-500 file:mr-4 file:py-3 file:px-6 file:rounded-xl file:border-0 file:text-xs file:font-bold file:bg-white file:text-emerald-700 hover:file:bg-emerald-50 transition-colors cursor-pointer border border-stone-200 rounded-xl bg-white relative z-10" 
                                     />
                                 </div>
                             </div>
                             
                             <Button 
                                onClick={handleConfirm} 
                                disabled={uploading} 
                                variant="primary" 
                                size="lg" 
                                className="w-full shadow-xl"
                             >
                                 {uploading ? <><Loader2 className="animate-spin w-5 h-5"/> Verifying...</> : "Confirm Payment"}
                             </Button>
                         </div>
                     </div>
                 </Modal>
             );
          };

        // --- 7. FEATURE COMPONENT: DELIVERY DASHBOARD ---

        /**
         * Delivery Partner Dashboard
         * Manages available orders, active jobs, profile, and rejection strikes.
         */
        const DeliveryDashboard = ({ currentUser, showNotification, handleLogout }) => {
            const [tab, setTab] = useState('available'); // 'available' | 'my_jobs' | 'profile'
            const [orders, setOrders] = useState([]);
            const [vehicleForm, setVehicleForm] = useState({ 
                  name: currentUser.vehicleName || '', 
                  number: currentUser.vehicleNumber || '' 
            });
            const [loadingAction, setLoadingAction] = useState(false);
            
            // --- Logic: Fetch Orders ---
            useEffect(() => {
                let q;
                if (tab === 'available') {
                    // Fetch orders waiting for pickup that haven't been assigned
                    q = query(getCollection("orders"), where("status", "==", "Ready for Pickup"));
                } else {
                    // Fetch orders assigned to this specific driver
                    q = query(getCollection("orders"), where("deliveryGuyId", "==", currentUser.uid));
                }
                
                const unsubscribe = onSnapshot(q, snap => {
                    const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    
                    if(tab === 'available') {
                        // Double check locally to ensure no race conditions on assignment
                        setOrders(data.filter(o => !o.deliveryGuyId));
                    } else {
                        // Sort active jobs to top
                        data.sort((a,b) => (a.status === 'Delivered' ? 1 : -1));
                        setOrders(data);
                    }
                });
                return () => unsubscribe();
            }, [tab, currentUser.uid]);

            // --- Logic: Accept Order ---
            const acceptOrder = async (id) => {
                setLoadingAction(true);
                try {
                    await updateDoc(getDocRef("orders", id), { 
                        status: 'Out for Delivery', 
                        deliveryGuyId: currentUser.uid,
                        deliveryGuyName: currentUser.name 
                    });
                    showNotification("Order Accepted! Start your engine.", "success");
                    setTab('my_jobs'); // Auto switch to active jobs
                } catch(e) { 
                    showNotification("Error accepting order. It may have been taken.", "error"); 
                } finally {
                    setLoadingAction(false);
                }
            };

            // --- Logic: Reject Order (Strike System) ---
            const rejectOrder = async () => {
                // Optimistic UI update handled by Firebase listener usually, but for user doc we might need force
                const currentStrikes = currentUser.rejectionCount || 0;
                const newStrikes = currentStrikes + 1;
                
                try {
                    const updates = { rejectionCount: newStrikes };
                    let message = `Order Skipped. Strike ${newStrikes}/3 applied.`;
                    let type = "error";

                    if (newStrikes >= 3) {
                        updates.status = 'suspended';
                        updates.isSuspended = true;
                        updates.rejectionReason = "Excessive order rejections (3 strikes).";
                        message = "CRITICAL: Account Suspended due to excessive rejections.";
                    }
                    
                    await updateDoc(getDocRef("users", currentUser.uid), updates);
                    showNotification(message, type);

                    if (newStrikes >= 3) {
                         // Force reload to trigger suspension screen
                         setTimeout(() => window.location.reload(), 1500);
                    }
                } catch(e) {
                    console.error("Rejection logic failed", e);
                    showNotification("System error. Please try again.", "error");
                }
            };

            // --- Logic: Complete Delivery ---
            const markDelivered = async (id) => {
                try {
                    await updateDoc(getDocRef("orders", id), { status: 'Delivered' });
                    showNotification("Great job! Order delivered successfully.", "success");
                } catch(e) {
                    showNotification("Update failed", "error");
                }
            };

            // --- Logic: Update Profile ---
             const updateVehicle = async (e) => {
                  e.preventDefault();
                  try {
                      await updateDoc(getDocRef("users", currentUser.uid), {
                          vehicleName: vehicleForm.name,
                          vehicleNumber: vehicleForm.number
                      });
                      showNotification("Vehicle details updated.", "success");
                  } catch (e) {
                      showNotification("Update failed.", "error");
                  }
              };

            // --- RENDER: Suspended State ---
            if(currentUser.status === 'suspended') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-stone-50 p-6 text-center animate-in fade-in">
                        <div className="bg-white p-12 rounded-[3rem] shadow-xl max-w-md border-2 border-red-100">
                            <div className="w-24 h-24 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-8 text-red-500">
                                <Ban className="w-12 h-12"/>
                            </div>
                            <h1 className="text-4xl font-display font-black text-stone-900 mb-4">Account Suspended</h1>
                            <p className="text-stone-500 mb-8 leading-relaxed text-lg">
                                You have reached the maximum limit of 3 rejected orders. Your account has been temporarily locked to ensure service reliability.
                            </p>
                            <div className="space-y-3">
                                <p className="text-xs font-bold text-stone-400 uppercase">Contact Support to Appeal</p>
                                <a href="mailto:farm2home@support.in" className="block text-emerald-600 font-bold hover:underline">farm2home@support.in</a>
                            </div>
                            <Button onClick={() => window.location.reload()} variant="dark" className="mt-8 w-full">Refresh Status</Button>
                        </div>
                    </div>
                );
            }
            
            // --- RENDER: Pending State ---
            if (currentUser.status === 'pending') {
                  return (
                      <div className="min-h-screen flex items-center justify-center bg-stone-50 p-6 animate-in fade-in">
                           <div className="bg-white p-10 rounded-[2.5rem] shadow-xl text-center max-w-md border border-stone-100">
                              <div className="w-20 h-20 bg-amber-50 rounded-full flex items-center justify-center mx-auto mb-6 text-amber-500">
                                  <Clock className="w-10 h-10 animate-pulse"/>
                              </div>
                              <h1 className="text-3xl font-display font-black text-stone-900 mb-3">Verification Pending</h1>
                              <p className="text-stone-500 mb-8 leading-relaxed">
                                  Thanks for signing up! Our team is currently reviewing your ID documents and vehicle registration. This usually takes 24-48 hours.
                              </p>
                              
                              <div className="bg-stone-50 rounded-xl p-4 text-left space-y-3 mb-8">
                                  <div className="flex items-center gap-3">
                                      <CheckCircle className="w-5 h-5 text-emerald-500"/>
                                      <span className="text-sm font-medium text-stone-700">Account Created</span>
                                  </div>
                                  <div className="flex items-center gap-3">
                                      <CheckCircle className="w-5 h-5 text-emerald-500"/>
                                      <span className="text-sm font-medium text-stone-700">Documents Uploaded</span>
                                  </div>
                                  <div className="flex items-center gap-3 opacity-50">
                                      <div className="w-5 h-5 rounded-full border-2 border-stone-300"></div>
                                      <span className="text-sm font-medium text-stone-700">Admin Approval</span>
                                  </div>
                              </div>
                              
                              <Button onClick={handleLogout} variant="secondary" fullWidth>Log Out</Button>
                          </div>
                      </div>
                  );
              }
            
            // --- RENDER: Rejected State ---
            if (currentUser.status === 'rejected') {
                  return (
                      <div className="min-h-screen flex items-center justify-center bg-stone-50 p-6 animate-in fade-in">
                           <div className="bg-white p-10 rounded-[2.5rem] shadow-xl text-center max-w-md border-2 border-red-100">
                              <div className="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-6 text-red-500 animate-bounce-slight">
                                  <XCircle className="w-10 h-10"/>
                              </div>
                              <h1 className="text-3xl font-display font-black text-stone-900 mb-3">Application Rejected</h1>
                              <p className="text-stone-500 mb-6 leading-relaxed">
                                  We're sorry, but your application was not approved at this time.
                              </p>
                              {currentUser.rejectionReason && (
                                  <div className="bg-red-50 p-5 rounded-xl mb-8 text-left border border-red-100">
                                      <span className="text-xs font-bold text-red-900 uppercase tracking-wide block mb-1">Reason for Rejection</span>
                                      <p className="text-sm text-red-700">{currentUser.rejectionReason}</p>
                                  </div>
                              )}
                              <Button onClick={handleLogout} variant="dark" fullWidth>Sign Out</Button>
                          </div>
                      </div>
                  );
              }

            // --- RENDER: Main Dashboard ---
            return (
                <div className="min-h-screen pt-28 px-4 bg-stone-50">
                    <div className="max-w-5xl mx-auto">
                        <div className="mb-10 flex flex-col md:flex-row justify-between items-end gap-6">
                            <div>
                                <h1 className="text-4xl font-display font-black text-stone-900 mb-2">Delivery Hub</h1>
                                <div className="flex items-center gap-2 text-stone-500 bg-white px-3 py-1.5 rounded-lg border border-stone-200 w-fit shadow-sm">
                                    <Truck className="w-4 h-4"/>
                                    <span className="text-sm font-medium">Vehicle: <span className="font-bold text-stone-800">{currentUser.vehicleName} ({currentUser.vehicleNumber})</span></span>
                                </div>
                            </div>
                            
                            <div className="flex gap-2 bg-white p-1.5 rounded-2xl shadow-sm border border-stone-200">
                                {['available', 'my_jobs', 'profile'].map(t => (
                                      <button 
                                          key={t}
                                          onClick={() => setTab(t)}
                                          className={`px-6 py-2.5 rounded-xl font-bold text-xs capitalize transition-all duration-300 ${tab === t ? 'bg-stone-900 text-white shadow-lg transform scale-105' : 'text-stone-500 hover:text-stone-800 hover:bg-stone-50'}`}
                                      >
                                          {t === 'available' ? `Available (${availableOrders.length})` : t.replace('_', ' ')}
                                      </button>
                                  ))}
                            </div>
                        </div>
                        
                        <div className="grid gap-6 animate-in slide-up">
                            {/* AVAILABLE ORDERS */}
                            {tab === 'available' && (
                                orders.length === 0 ? (
                                    <div className="col-span-full text-center py-24 bg-white rounded-[2.5rem] border border-dashed border-stone-200 shadow-sm">
                                        <div className="w-20 h-20 bg-stone-50 rounded-full flex items-center justify-center mx-auto mb-6 text-stone-300">
                                            <Bike className="w-10 h-10"/>
                                        </div>
                                        <h3 className="text-xl font-bold text-stone-800 mb-2">No orders nearby</h3>
                                        <p className="text-stone-500 text-sm">Relax for a moment! New orders will appear here automatically.</p>
                                    </div>
                                ) : (
                                    <div className="grid md:grid-cols-2 gap-6">
                                        {orders.map(order => (
                                            <div key={order.id} className="bg-white p-8 rounded-[2rem] shadow-xl shadow-stone-200/50 border border-stone-100 relative overflow-hidden transition-all hover:-translate-y-1 hover:shadow-2xl">
                                                <div className="absolute top-0 left-0 w-1.5 h-full bg-emerald-500"></div>
                                                <div className="flex justify-between items-start mb-6">
                                                    <Badge color="emerald">Pickup Ready</Badge>
                                                    <span className="font-mono text-xs text-stone-400 bg-stone-50 px-2 py-1 rounded">#{order.id.slice(0,6)}</span>
                                                </div>
                                                
                                                <div className="space-y-4 mb-8">
                                                    <div className="flex items-start gap-4">
                                                        <div className="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center shrink-0 border border-emerald-100 text-emerald-600"><Store className="w-5 h-5"/></div>
                                                        <div>
                                                            <p className="text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-0.5">Pickup From</p>
                                                            <p className="font-bold text-stone-900 text-lg leading-tight">{order.items?.[0]?.farmerName || 'Local Farm'}</p>
                                                            <p className="text-xs text-stone-500 mt-1">~ 2.5 km away</p>
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="w-0.5 h-6 bg-stone-100 ml-5"></div>
                                                    
                                                    <div className="flex items-start gap-4">
                                                        <div className="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center shrink-0 border border-orange-100 text-orange-600"><MapPin className="w-5 h-5"/></div>
                                                        <div>
                                                            <p className="text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-0.5">Deliver To</p>
                                                            <p className="font-bold text-stone-900 text-lg leading-tight">{order.delivery.address}</p>
                                                            <p className="text-xs text-stone-500 mt-1">{order.delivery.zip}</p>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="flex items-center justify-between pt-5 border-t border-stone-100 mb-6 bg-stone-50/50 -mx-8 px-8 py-4 mt-auto">
                                                    <div>
                                                        <span className="text-stone-400 text-xs font-bold uppercase block mb-0.5">Est. Earnings</span>
                                                        <span className="text-xl font-black text-emerald-700">{Math.floor(order.total * 0.15)}</span>
                                                    </div>
                                                    <div className="text-right">
                                                        <span className="text-stone-400 text-xs font-bold uppercase block mb-0.5">Items</span>
                                                        <span className="text-sm font-bold text-stone-700">{order.items.length} Packages</span>
                                                    </div>
                                                </div>

                                                <div className="grid grid-cols-2 gap-4">
                                                    <Button onClick={() => acceptOrder(order.id)} variant="primary" size="lg" disabled={loadingAction} className="shadow-emerald-500/20">
                                                        Accept
                                                    </Button>
                                                    <Button onClick={rejectOrder} variant="danger" size="lg" disabled={loadingAction} className="bg-white">
                                                        Reject
                                                    </Button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )
                            )}

                            {/* ACTIVE JOBS TAB */}
                            {tab === 'my_jobs' && (
                                <div className="space-y-8">
                                    {/* Active Job Cards */}
                                    {orders.filter(o => o.status === 'Out for Delivery').map(o => (
                                          <div key={o.id} className="bg-stone-900 text-white p-8 rounded-[3rem] shadow-2xl relative overflow-hidden">
                                              <div className="absolute -top-10 -right-10 opacity-10"><Bike className="w-64 h-64 text-white"/></div>
                                              
                                              <div className="relative z-10">
                                                  <div className="flex justify-between items-center mb-8">
                                                      <div className="flex items-center gap-3">
                                                          <span className="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                                                          <h3 className="text-2xl font-black tracking-tight">Active Delivery</h3>
                                                      </div>
                                                      <span className="font-mono text-sm opacity-50 bg-white/10 px-3 py-1 rounded-lg">Order #{o.id.slice(0,6)}</span>
                                                  </div>

                                                  <div className="grid md:grid-cols-2 gap-6 mb-10">
                                                      <div className="bg-white/5 p-6 rounded-3xl border border-white/10 hover:bg-white/10 transition-colors">
                                                          <h4 className="font-bold text-emerald-400 mb-4 flex items-center gap-2 text-xs uppercase tracking-wider"><User className="w-4 h-4"/> Customer</h4>
                                                          <p className="text-xl font-bold mb-1">{o.delivery.name}</p>
                                                          <p className="text-stone-400 mb-4">{o.delivery.phone}</p>
                                                          <a href={`tel:${o.delivery.phone}`} className="inline-flex items-center gap-2 text-xs font-bold bg-white text-stone-900 px-4 py-2.5 rounded-xl hover:bg-emerald-400 transition-colors"><Phone className="w-3 h-3"/> Call Now</a>
                                                      </div>
                                                      <div className="bg-white/5 p-6 rounded-3xl border border-white/10 hover:bg-white/10 transition-colors">
                                                          <h4 className="font-bold text-orange-400 mb-4 flex items-center gap-2 text-xs uppercase tracking-wider"><MapPin className="w-4 h-4"/> Drop-off</h4>
                                                          <p className="text-xl font-bold mb-1 leading-snug">{o.delivery.address}</p>
                                                          <p className="text-stone-400 mb-4">{o.delivery.state}, {o.delivery.zip}</p>
                                                          <a href={`https://maps.google.com/?q=${o.delivery.address}`} target="_blank" className="inline-flex items-center gap-2 text-xs font-bold bg-white text-stone-900 px-4 py-2.5 rounded-xl hover:bg-orange-400 transition-colors"><ExternalLink className="w-3 h-3"/> Navigation</a>
                                                      </div>
                                                  </div>

                                                  <Button 
                                                      onClick={() => markDelivered(o.id)} 
                                                      variant="primary" 
                                                      size="lg" 
                                                      className="w-full bg-gradient-to-r from-emerald-500 to-green-600 border-none h-16 text-xl shadow-2xl shadow-green-900/50"
                                                      icon={CheckCircle}
                                                  >
                                                      Swipe to Complete Delivery
                                                  </Button>
                                              </div>
                                          </div>
                                    ))}
                                    
                                    {orders.filter(o => o.status === 'Out for Delivery').length === 0 && (
                                          <div className="text-center py-10 bg-white rounded-[2rem] border border-stone-100">
                                              <p className="text-stone-500 font-medium">You have no active deliveries right now.</p>
                                          </div>
                                    )}

                                    {/* Delivered History */}
                                    {orders.filter(o => o.status === 'Delivered').length > 0 && (
                                        <div className="animate-in slide-up">
                                            <h3 className="font-bold text-xl text-stone-900 mb-6 pl-2 border-l-4 border-emerald-500 ml-1">Completed Jobs</h3>
                                            <div className="grid gap-4">
                                                {orders.filter(o => o.status === 'Delivered').map(order => (
                                                    <div key={order.id} className="bg-white p-5 rounded-2xl flex justify-between items-center shadow-sm hover:shadow-md transition-shadow border border-stone-100">
                                                        <div className="flex items-center gap-4">
                                                            <div className="w-10 h-10 bg-stone-100 rounded-full flex items-center justify-center text-stone-400"><CheckCircle className="w-5 h-5"/></div>
                                                            <div>
                                                                <p className="font-bold text-stone-900">Order #{order.id.slice(0,6)}</p>
                                                                <p className="text-xs text-stone-500 mt-0.5">{new Date(order.createdAt?.seconds * 1000).toLocaleDateString()}  {order.delivery.address}</p>
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <p className="font-black text-emerald-600 text-lg">+ {Math.floor(order.total * 0.15)}</p>
                                                            <span className="text-[10px] font-bold uppercase bg-emerald-50 text-emerald-700 px-2 py-0.5 rounded">Paid</span>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* PROFILE TAB */}
                            {tab === 'profile' && (
                                  <div className="max-w-lg mx-auto bg-white p-8 rounded-[2.5rem] shadow-xl border border-stone-100 animate-in fade-in">
                                      <div className="text-center mb-8">
                                          <div className="w-24 h-24 bg-stone-100 rounded-full mx-auto mb-4 flex items-center justify-center border-4 border-white shadow-lg text-stone-400"><User className="w-10 h-10"/></div>
                                          <h3 className="font-bold text-2xl text-stone-900">{currentUser.name}</h3>
                                          <p className="text-stone-500 text-sm">{currentUser.email}</p>
                                      </div>
                                      
                                      <form onSubmit={updateVehicle} className="space-y-6">
                                          <div className="space-y-4">
                                              <h4 className="text-xs font-bold text-stone-400 uppercase tracking-wider border-b border-stone-100 pb-2">Vehicle Configuration</h4>
                                              <Input label="Vehicle Model" value={vehicleForm.name} onChange={e => setVehicleForm({...vehicleForm, name: e.target.value})} placeholder="e.g. Honda Activa 6G"/>
                                              <Input label="Registration Number" value={vehicleForm.number} onChange={e => setVehicleForm({...vehicleForm, number: e.target.value})} placeholder="e.g. MH-12-AB-1234"/>
                                          </div>
                                          
                                          <div className="bg-stone-50 p-4 rounded-xl flex justify-between items-center">
                                               <span className="text-sm font-bold text-stone-600">Rejection Count</span>
                                               <span className={`text-sm font-black px-3 py-1 rounded-lg ${currentUser.rejectionCount > 1 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>{currentUser.rejectionCount || 0} / 3</span>
                                          </div>

                                          <Button type="submit" variant="dark" className="w-full" disabled={loadingAction}>
                                              {loadingAction ? "Updating..." : "Save Changes"}
                                          </Button>
                                      </form>
                                  </div>
                              )}
                        </div>
                    </div>
                </div>
            );
        };
// --- 8. FEATURE COMPONENTS: FARMER & ADMIN DASHBOARDS ---

        /**
         * Farmer Dashboard
         * Allows farmers to manage inventory and view orders assigned to them.
         */
        const FarmerDashboard = () => {
            const { currentUser, showNotification, handleLogout } = useGlobalState();
            const [tab, setTab] = useState('inventory'); // 'inventory' | 'orders' | 'profile'
            const [myOrders, setMyOrders] = useState([]);
            const [products, setProducts] = useState([]);
            const [loadingAction, setLoadingAction] = useState(false);

            // Product Form State
            const [newProd, setNewProd] = useState({ 
                name: '', price: '', stock: '', unit: 'kg', 
                pesticides: false, description: '', farmAddress: '', state: '' 
            });
            const [prodFile, setProdFile] = useState(null);
            const [editingId, setEditingId] = useState(null);
            const [deleteConfirmId, setDeleteConfirmId] = useState(null);

            // Fetch Products
            useEffect(() => {
                const q = query(getCollection("products"), where("farmerId", "==", currentUser.uid));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Client sort
                    items.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setProducts(items);
                });
                return () => unsubscribe();
            }, [currentUser.uid]);

            // Fetch Orders
            useEffect(() => {
                if (tab === 'orders') {
                    const q = query(getCollection("orders"), where("farmerId", "==", currentUser.uid), orderBy("createdAt", "desc"));
                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        setMyOrders(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    }, (error) => {
                        console.error("Farmer orders fetch error:", error);
                    });
                    return () => unsubscribe();
                }
            }, [tab, currentUser.uid]);

            const handleSaveProduct = async (e) => {
                e.preventDefault();
                setLoadingAction(true);
                try {
                    let imageUrl = newProd.imageUrl || ""; 
                    if (prodFile) {
                        imageUrl = await uploadToCloudinary(prodFile);
                    } else if (!imageUrl && !editingId) {
                        // Default image if none provided
                        imageUrl = "https://images.unsplash.com/photo-1595855709915-445676396827?auto=format&fit=crop&q=80";
                    }

                    const productData = { 
                        ...newProd, 
                        imageUrl, 
                        farmerId: currentUser.uid, 
                        farmerName: currentUser.name, 
                        status: 'pending', // Always reset to pending on edit to ensure re-review
                        updatedAt: serverTimestamp() 
                    };

                    if (editingId) {
                        await updateDoc(getDocRef("products", editingId), productData);
                        showNotification("Product updated! Sent for re-approval.", "success");
                    } else {
                        productData.createdAt = serverTimestamp();
                        await addDoc(getCollection("products"), productData);
                        showNotification("Product added! Pending Admin approval.", "success");
                    }

                    // Reset Form
                    setNewProd({ name: '', price: '', stock: '', unit: 'kg', pesticides: false, description: '', farmAddress: '', state: '' });
                    setProdFile(null);
                    setEditingId(null);
                } catch (error) { 
                    console.error(error); 
                    showNotification("Failed to save product.", "error");
                } finally { 
                    setLoadingAction(false); 
                }
            };

            const handleDeleteProduct = async () => {
                if (!deleteConfirmId) return;
                try {
                    await deleteDoc(getDocRef("products", deleteConfirmId));
                    showNotification("Product removed from inventory.", "success");
                } catch (error) {
                    showNotification("Deletion failed.", "error");
                } finally {
                    setDeleteConfirmId(null);
                }
            };

            const handleEditInit = (product) => {
                setNewProd(product);
                setEditingId(product.id);
                setProdFile(null);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const handleOrderAction = async (orderId, status) => {
                try {
                    await updateDoc(getDocRef("orders", orderId), { status });
                    const messages = {
                        'Preparing': 'Order Accepted! Start packing.',
                        'Ready for Pickup': 'Marked Ready! Delivery partner notified.',
                        'Rejected': 'Order Rejected.'
                    };
                    showNotification(messages[status] || "Status updated", "success");
                } catch (e) {
                    showNotification("Action failed.", "error");
                }
            };

            // Rejection/Pending States for Farmer
            if (currentUser.status === 'rejected') {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-stone-50 p-6 animate-in fade-in">
                        <div className="bg-white p-10 rounded-[2.5rem] shadow-xl text-center max-w-md border-2 border-red-100">
                            <div className="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-6 text-red-500 animate-bounce-slight">
                                <Ban className="w-10 h-10"/>
                            </div>
                            <h1 className="text-3xl font-display font-black text-stone-900 mb-3">Account Rejected</h1>
                            <p className="text-stone-500 mb-6 leading-relaxed">
                                We're sorry, but your Farmer application was not approved.
                            </p>
                            {currentUser.rejectionReason && (
                                <div className="bg-red-50 p-5 rounded-xl mb-8 text-left border border-red-100">
                                    <span className="text-xs font-bold text-red-900 uppercase tracking-wide block mb-1">Reason</span>
                                    <p className="text-sm text-red-700">{currentUser.rejectionReason}</p>
                                </div>
                            )}
                            <Button onClick={handleLogout} variant="dark" fullWidth>Sign Out</Button>
                        </div>
                    </div>
                );
            }

            if (currentUser.status === 'pending') {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-stone-50 p-6 animate-in fade-in">
                        <div className="bg-white p-10 rounded-[2.5rem] shadow-xl text-center max-w-md border border-stone-100">
                            <div className="w-20 h-20 bg-amber-50 rounded-full flex items-center justify-center mx-auto mb-6 text-amber-500">
                                <Clock className="w-10 h-10 animate-pulse"/>
                            </div>
                            <h1 className="text-3xl font-display font-black text-stone-900 mb-3">Verification Pending</h1>
                            <p className="text-stone-500 mb-8 leading-relaxed">
                                Your account is currently under review by our administration team. You will be notified once approved.
                            </p>
                            <Button onClick={handleLogout} variant="secondary" fullWidth>Log Out</Button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pt-28 pb-12 px-4 bg-stone-50">
                    <ConfirmationModal 
                        isOpen={!!deleteConfirmId} 
                        title="Delete Product?" 
                        message="This will permanently remove the item from your inventory." 
                        confirmText="Delete" 
                        isDangerous={true} 
                        onConfirm={handleDeleteProduct} 
                        onCancel={() => setDeleteConfirmId(null)} 
                    />

                    <div className="max-w-6xl mx-auto">
                        <div className="mb-10 flex flex-col md:flex-row justify-between items-end gap-6">
                            <div>
                                <h1 className="text-4xl font-display font-black text-stone-900 tracking-tight">Farmer Dashboard</h1>
                                <p className="text-stone-500 mt-2 text-lg">Manage your harvest and fulfill orders</p>
                            </div>
                            <div className="flex bg-white p-1.5 rounded-2xl shadow-sm border border-stone-100">
                                <button onClick={() => setTab('inventory')} className={`px-6 py-2.5 rounded-xl font-bold text-sm transition-all ${tab === 'inventory' ? 'bg-stone-900 text-white shadow-lg' : 'text-stone-500 hover:text-stone-800'}`}>Inventory</button>
                                <button onClick={() => setTab('orders')} className={`px-6 py-2.5 rounded-xl font-bold text-sm transition-all ${tab === 'orders' ? 'bg-stone-900 text-white shadow-lg' : 'text-stone-500 hover:text-stone-800'}`}>Orders</button>
                            </div>
                        </div>

                        {tab === 'inventory' && (
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                {/* Form Section */}
                                <div className="lg:col-span-1">
                                    <div className="bg-white p-8 rounded-[2rem] shadow-xl border border-stone-100 sticky top-28">
                                        <div className="flex justify-between items-center mb-6">
                                            <h3 className="text-xl font-bold text-stone-900">{editingId ? 'Edit Product' : 'Add Harvest'}</h3>
                                            {editingId && <button onClick={() => { setEditingId(null); setNewProd({ name: '', price: '', stock: '', unit: 'kg', pesticides: false, description: '', farmAddress: '', state: '' }); }} className="text-xs font-bold text-stone-400 hover:text-stone-600">Cancel</button>}
                                        </div>
                                        
                                        <form className="space-y-4" onSubmit={handleSaveProduct}>
                                            <Input required placeholder="Product Name" value={newProd.name} onChange={e => setNewProd({...newProd, name: e.target.value})} />
                                            <div className="grid grid-cols-2 gap-4">
                                                <Input required type="number" placeholder="Price ()" value={newProd.price} onChange={e => setNewProd({...newProd, price: Number(e.target.value)})} />
                                                <Select 
                                                    value={newProd.unit} 
                                                    onChange={e => setNewProd({...newProd, unit: e.target.value})}
                                                    options={[
                                                        {value: 'kg', label: 'Per Kg'},
                                                        {value: 'bunch', label: 'Per Bunch'},
                                                        {value: 'piece', label: 'Per Piece'},
                                                        {value: 'dozen', label: 'Per Dozen'}
                                                    ]}
                                                />
                                            </div>
                                            <Input required type="number" placeholder="Stock Qty" value={newProd.stock} onChange={e => setNewProd({...newProd, stock: Number(e.target.value)})} />
                                            
                                            {/* Pesticide Toggle */}
                                            <div 
                                                className={`flex items-center gap-3 p-4 rounded-xl cursor-pointer transition-colors border ${newProd.pesticides ? 'bg-emerald-50 border-emerald-200' : 'bg-stone-50 border-stone-200'}`}
                                                onClick={() => setNewProd({...newProd, pesticides: !newProd.pesticides})}
                                            >
                                                <div className={`w-5 h-5 rounded border flex items-center justify-center transition-colors ${newProd.pesticides ? 'bg-emerald-600 border-emerald-600' : 'bg-white border-stone-300'}`}>
                                                    {newProd.pesticides && <CheckCircle className="w-3.5 h-3.5 text-white" />}
                                                </div>
                                                <span className={`text-sm font-bold ${newProd.pesticides ? 'text-emerald-800' : 'text-stone-500'}`}>Organic / Pesticide Free?</span>
                                            </div>

                                            <Textarea placeholder="Describe your harvest..." value={newProd.description} onChange={e => setNewProd({...newProd, description: e.target.value})} />
                                            
                                            <div className="border-2 border-dashed border-stone-200 rounded-2xl p-4 text-center hover:bg-stone-50 transition-colors relative cursor-pointer group">
                                                <span className="text-sm font-bold text-stone-500 group-hover:text-emerald-700 transition-colors">{prodFile ? prodFile.name : (newProd.imageUrl ? "Change Image" : "Upload Image")}</span>
                                                <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={(e) => setProdFile(e.target.files[0])} />
                                            </div>

                                            <Button type="submit" disabled={loadingAction} className="w-full" size="lg">
                                                {loadingAction ? <Spinner className="text-white"/> : (editingId ? 'Update Product' : 'Submit for Review')}
                                            </Button>
                                        </form>
                                    </div>
                                </div>

                                {/* Product List */}
                                <div className="lg:col-span-2 space-y-4">
                                    {products.length === 0 && (
                                        <div className="text-center py-20 bg-white rounded-[2rem] border border-dashed border-stone-200">
                                            <Leaf className="w-12 h-12 text-stone-200 mx-auto mb-4"/>
                                            <p className="text-stone-400 font-medium">Your inventory is empty. Add your first harvest!</p>
                                        </div>
                                    )}
                                    {products.map(p => (
                                        <div key={p.id} className="better-box p-5 flex flex-col sm:flex-row items-center gap-6 group bg-white animate-in slide-up">
                                            <img src={p.imageUrl} className="w-full sm:w-24 h-24 rounded-2xl object-cover bg-stone-100 shadow-sm" />
                                            <div className="flex-1 w-full text-center sm:text-left">
                                                <div className="flex items-center justify-center sm:justify-start gap-3 mb-2">
                                                    <h4 className="text-xl font-bold text-stone-900">{p.name}</h4>
                                                    <StatusBadge status={p.status}/>
                                                </div>
                                                <div className="flex items-center justify-center sm:justify-start gap-4 text-sm text-stone-500 mb-2">
                                                    <span className="flex items-center gap-1"><Package className="w-4 h-4"/> {p.stock} {p.unit}</span>
                                                    <span className="flex items-center gap-1"><DollarSign className="w-4 h-4"/> {p.price}</span>
                                                    {p.pesticides && <span className="flex items-center gap-1 text-emerald-600"><Leaf className="w-4 h-4"/> Organic</span>}
                                                </div>
                                                {p.status === 'rejected' && <p className="text-xs text-red-500 bg-red-50 p-2 rounded-lg font-medium border border-red-100">Reason: {p.rejectionReason}</p>}
                                            </div>
                                            <div className="flex gap-2 w-full sm:w-auto">
                                                <button onClick={() => handleEditInit(p)} className="flex-1 sm:flex-none p-3 bg-stone-100 text-stone-600 rounded-xl hover:bg-stone-200 transition-colors"><Edit2 className="w-5 h-5"/></button>
                                                <button onClick={() => setDeleteConfirmId(p.id)} className="flex-1 sm:flex-none p-3 bg-red-50 text-red-600 rounded-xl hover:bg-red-100 transition-colors"><Trash2 className="w-5 h-5"/></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {tab === 'orders' && (
                            <div className="space-y-6">
                                {myOrders.length === 0 && (
                                    <div className="text-center py-20 bg-white rounded-[2rem] border border-dashed border-stone-200">
                                        <Package className="w-12 h-12 text-stone-200 mx-auto mb-4"/>
                                        <p className="text-stone-400 font-medium">No orders yet.</p>
                                    </div>
                                )}
                                {myOrders.map(order => (
                                    <div key={order.id} className="better-box p-8 border-l-4 border-l-stone-900 relative bg-white animate-in slide-up">
                                        <div className="flex justify-between items-start mb-6 border-b border-stone-100 pb-4">
                                            <div>
                                                <h4 className="font-bold text-xl text-stone-900">Order #{order.id.slice(0,6)}</h4>
                                                <div className="mt-2"><StatusBadge status={order.status}/></div>
                                            </div>
                                            <div className="text-right">
                                                <span className="block text-xs font-bold text-stone-400 uppercase">Earnings</span>
                                                <span className="text-2xl font-black text-stone-900">{formatINR(order.total)}</span>
                                            </div>
                                        </div>
                                        
                                        <div className="space-y-3 mb-6 bg-stone-50 p-4 rounded-xl">
                                            {(order.items || []).map((item, idx) => (
                                                <div key={idx} className="flex justify-between text-sm">
                                                    <span className="font-bold text-stone-700">{item.name} <span className="text-stone-400 font-normal">x{item.quantity}</span></span>
                                                    <span className="font-bold text-stone-900">{formatINR(item.price * item.quantity)}</span>
                                                </div>
                                            ))}
                                        </div>
                                        
                                        <div className="flex items-center gap-3 text-xs text-stone-400 mb-6">
                                            <Calendar className="w-4 h-4"/> {formatDate(order.createdAt)}
                                        </div>

                                        <div className="mt-6 pt-6 border-t border-stone-100">
                                            {order.status === 'Payment Review' && (
                                                <div className="flex items-center gap-3 text-amber-600 bg-amber-50 p-4 rounded-xl border border-amber-100">
                                                    <Loader2 className="animate-spin w-5 h-5"/>
                                                    <span className="font-bold text-sm">Waiting for Admin Payment Verification</span>
                                                </div>
                                            )}
                                            
                                            {order.status === 'Payment Verified' && (
                                                <div className="flex gap-4 animate-in fade-in">
                                                    <Button onClick={() => handleOrderAction(order.id, 'Preparing')} variant="primary" size="lg" className="flex-1" icon={Package}>Accept Order</Button>
                                                    <Button onClick={() => handleOrderAction(order.id, 'Rejected')} variant="danger" size="lg">Reject</Button>
                                                </div>
                                            )}

                                            {order.status === 'Preparing' && (
                                                <Button onClick={() => handleOrderAction(order.id, 'Ready for Pickup')} variant="primary" size="lg" className="w-full bg-indigo-600 hover:bg-indigo-700 shadow-indigo-200" icon={Bike}>
                                                    Mark Ready for Pickup
                                                </Button>
                                            )}

                                            {order.status === 'Ready for Pickup' && (
                                                <div className="text-center text-teal-700 font-bold bg-teal-50 p-4 rounded-xl flex items-center justify-center gap-2 border border-teal-100">
                                                    <Loader2 className="w-4 h-4 animate-spin"/> Waiting for Delivery Partner Assignment
                                                </div>
                                            )}
                                            
                                            {order.status === 'Out for Delivery' && (
                                                <div className="text-center text-purple-700 font-bold bg-purple-50 p-4 rounded-xl flex items-center justify-center gap-2 border border-purple-100">
                                                    <Bike className="w-5 h-5"/> En Route to Customer
                                                </div>
                                            )}
                                            
                                            {order.status === 'Delivered' && (
                                                <div className="text-center text-emerald-700 font-bold bg-emerald-50 p-4 rounded-xl flex items-center justify-center gap-2 border border-emerald-100">
                                                    <CheckCircle className="w-5 h-5"/> Order Completed
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        /**
         * Admin (Moderator) Dashboard
         * Manages user approvals, product moderation, order verification, and settings.
         */
        const ModDashboard = () => {
            const { showNotification } = useGlobalState();
            const [activeTab, setActiveTab] = useState('users'); 
            const [pendingUsers, setPendingUsers] = useState([]);
            const [allProducts, setAllProducts] = useState([]); 
            const [allOrders, setAllOrders] = useState([]); 
            const [paymentSettings, setPaymentSettings] = useState({ qrCodeUrl: "", upiId: "" });
            const [qrFile, setQrFile] = useState(null);
            const [rejectReason, setRejectReason] = useState("");
            const [productRejectReason, setProductRejectReason] = useState("");
            const [savingSettings, setSavingSettings] = useState(false);
            
            // Modal States
            const [selectedUserReject, setSelectedUserReject] = useState(null);
            const [selectedProductReject, setSelectedProductReject] = useState(null);
            const [selectedOrderReview, setSelectedOrderReview] = useState(null);
            
            useEffect(() => {
                const unsubUsers = onSnapshot(query(getCollection("users"), where("status", "==", "pending")), snap => 
                    setPendingUsers(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                
                const unsubProds = onSnapshot(query(getCollection("products")), snap => 
                    setAllProducts(snap.docs.map(d => ({id: d.id, ...d.data()}))));

                const unsubOrders = onSnapshot(query(getCollection("orders"), orderBy("createdAt", "desc")), snap => 
                    setAllOrders(snap.docs.map(d => ({id: d.id, ...d.data()}))));

                getDoc(getDocRef("settings", "payment")).then(s => { if (snap.exists()) setPaymentSettings(snap.data()); });

                return () => { unsubUsers(); unsubProds(); unsubOrders(); };
            }, []);

            const handleSaveSettings = async (e) => {
                e.preventDefault(); setSavingSettings(true);
                try {
                    let url = paymentSettings.qrCodeUrl;
                    if (qrFile) url = await uploadToCloudinary(qrFile);
                    await setDoc(getDocRef("settings", "payment"), { ...paymentSettings, qrCodeUrl: url });
                    showNotification("Settings updated successfully.", "success");
                } catch (e) { showNotification("Failed to save settings.", "error"); }
                finally { setSavingSettings(false); }
            };

            const handleUserUpdate = async (id, data) => {
                try { await updateDoc(getDocRef("users", id), data); showNotification("User status updated.", "success"); }
                catch(e) { showNotification("Update failed.", "error"); }
                setSelectedUserReject(null);
            };
            
            const handleProductUpdate = async (id, data) => {
                try { await updateDoc(getDocRef("products", id), data); showNotification("Product status updated.", "success"); }
                catch(e) { showNotification("Update failed.", "error"); }
                setSelectedProductReject(null);
            };

            const handleProductDelete = async (id) => {
                 try { await deleteDoc(getDocRef("products", id)); showNotification("Product permanently deleted.", "success"); }
                 catch(e) { showNotification("Delete failed.", "error"); }
            };

            const handleOrderVerification = async (id, status) => {
                try { await updateDoc(getDocRef("orders", id), { status }); showNotification(`Order ${status.split(' ')[1]}!`, "success"); setSelectedOrderReview(null); }
                catch(e) { showNotification("Verification action failed.", "error"); }
            };

            return (
              <div className="min-h-screen pt-28 pb-12 px-4 bg-stone-50">
                  <div className="max-w-6xl mx-auto">
                      <header className="mb-10 flex flex-col md:flex-row justify-between items-end gap-6">
                        <div>
                            <h1 className="text-4xl font-display font-black text-stone-900 tracking-tight">Admin Console</h1>
                            <p className="text-stone-500 mt-2 text-lg">Platform Moderation & Configuration</p>
                        </div>
                        <div className="flex bg-white p-1.5 rounded-2xl shadow-sm border border-stone-100 overflow-x-auto no-scrollbar">
                            {['users', 'products', 'orders', 'settings'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)} className={`px-5 py-2 rounded-xl font-bold text-xs capitalize whitespace-nowrap transition-all ${activeTab === tab ? 'bg-stone-900 text-white shadow-lg' : 'text-stone-500 hover:text-stone-800'}`}>{tab}</button>
                            ))}
                        </div>
                      </header>
                      
                      {/* USERS TAB */}
                      {activeTab === 'users' && (
                          <div className="space-y-4 animate-in fade-in">
                              <h3 className="font-bold text-xl mb-4 flex items-center gap-2"><Users className="w-5 h-5"/> Pending Approvals</h3>
                              {pendingUsers.map(user => (
                                  <div key={user.id} className="better-box p-6 flex flex-col md:flex-row justify-between items-center gap-6 bg-white">
                                      <div className="flex-1">
                                          <div className="flex items-center gap-3 mb-1">
                                              <h4 className="font-bold text-lg">{user.name}</h4>
                                              <span className="bg-stone-100 text-stone-600 text-xs px-2 py-1 rounded-lg font-bold uppercase tracking-wider">{user.role}</span>
                                          </div>
                                          <p className="text-sm text-stone-500 font-medium mb-2">{user.email}  {user.phone}</p>
                                          {user.role === 'delivery' && (
                                              <div className="inline-flex items-center gap-2 bg-blue-50 text-blue-700 px-3 py-1 rounded-lg text-xs font-bold border border-blue-100 mb-2">
                                                  <Bike className="w-3 h-3"/> {user.vehicleName} ({user.vehicleNumber})
                                              </div>
                                          )}
                                          {user.docUrl && (
                                              <a href={user.docUrl} target="_blank" className="flex items-center gap-2 text-emerald-600 text-xs font-bold hover:underline mt-1">
                                                  <ExternalLink className="w-3 h-3"/> View Verification Document
                                              </a>
                                          )}
                                      </div>
                                      <div className="flex gap-3 w-full md:w-auto">
                                          <Button onClick={() => handleUserUpdate(user.id, {status: 'active'})} variant="primary" size="sm" className="flex-1 md:flex-none">Approve</Button>
                                          <Button onClick={() => setSelectedUserReject(user.id)} variant="danger" size="sm" className="flex-1 md:flex-none">Reject</Button>
                                      </div>
                                  </div>
                              ))}
                              {pendingUsers.length === 0 && (
                                  <div className="text-center py-16 bg-white rounded-[2rem] border border-dashed border-stone-200">
                                      <CheckCircle className="w-12 h-12 text-emerald-200 mx-auto mb-4"/>
                                      <p className="text-stone-400 font-bold">All caught up! No pending user approvals.</p>
                                  </div>
                              )}
                          </div>
                      )}

                      {/* PRODUCTS TAB */}
                      {activeTab === 'products' && (
                          <div className="space-y-12 animate-in fade-in">
                              {/* Pending Section */}
                              <div>
                                  <h3 className="text-xl font-bold text-stone-900 mb-6 flex items-center gap-2 pb-4 border-b border-stone-200"><Clock className="w-5 h-5 text-amber-500"/> Pending Approval</h3>
                                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                      {allProducts.filter(p => p.status === 'pending').map(p => (
                                          <div key={p.id} className="better-box p-5 border-l-4 border-l-amber-400 bg-white">
                                              <div className="flex gap-4 mb-4">
                                                  <img src={p.imageUrl} className="w-20 h-20 rounded-xl object-cover bg-stone-100 shadow-sm"/>
                                                  <div>
                                                      <h4 className="font-bold text-lg leading-tight">{p.name}</h4>
                                                      <p className="text-xs text-stone-500 mb-1">by {p.farmerName}</p>
                                                      <p className="text-emerald-700 font-black">{formatINR(p.price)} / {p.unit}</p>
                                                      {p.pesticides && <span className="text-[10px] text-green-600 bg-green-50 px-2 py-0.5 rounded mt-1 inline-block">Organic</span>}
                                                  </div>
                                              </div>
                                              <div className="flex gap-2">
                                                  <Button onClick={() => handleProductUpdate(p.id, {status: 'approved'})} variant="primary" size="sm" className="flex-1">Approve</Button>
                                                  <Button onClick={() => setSelectedProductReject(p.id)} variant="danger" size="sm" className="flex-1">Reject</Button>
                                              </div>
                                          </div>
                                      ))}
                                      {allProducts.filter(p => p.status === 'pending').length === 0 && <p className="col-span-full text-stone-400 text-center py-8">No pending products.</p>}
                                  </div>
                              </div>
                              
                              {/* Live Inventory */}
                              <div>
                                  <h3 className="text-xl font-bold text-stone-900 mb-6 flex items-center gap-2 pb-4 border-b border-stone-200"><Store className="w-5 h-5 text-emerald-600"/> Live Inventory</h3>
                                  <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                      {allProducts.filter(p => p.status === 'approved').map(p => (
                                          <div key={p.id} className="better-box p-4 bg-white">
                                              <div className="flex gap-3 mb-4">
                                                  <img src={p.imageUrl} className="w-12 h-12 rounded-lg object-cover bg-stone-100"/>
                                                  <div className="min-w-0">
                                                      <h4 className="font-bold text-sm truncate">{p.name}</h4>
                                                      <p className="text-xs text-stone-500 truncate">by {p.farmerName}</p>
                                                      <p className="text-xs font-bold text-stone-700 mt-0.5">{p.stock} in stock</p>
                                                  </div>
                                              </div>
                                              <Button onClick={() => handleProductDelete(p.id)} variant="danger" size="sm" className="w-full bg-red-50 hover:bg-red-100 border-red-100 text-red-600" icon={Trash2}>Delete Listing</Button>
                                          </div>
                                      ))}
                                  </div>
                              </div>
                          </div>
                      )}

                      {/* ORDERS TAB */}
                      {activeTab === 'orders' && (
                          <div className="space-y-6 animate-in fade-in">
                              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                  {allOrders.map(order => (
                                      <div key={order.id} onClick={() => setSelectedOrderReview(order)} className="better-box p-6 cursor-pointer hover:shadow-xl transition-all bg-white relative group">
                                          {order.status === 'Payment Review' && <span className="absolute top-4 right-4 w-3 h-3 bg-amber-500 rounded-full animate-pulse shadow-[0_0_10px_#f59e0b]"></span>}
                                          <div className="flex justify-between items-start mb-3">
                                              <span className="text-xs font-mono text-stone-400 bg-stone-50 px-2 py-1 rounded">#{order.id.slice(0,6)}</span>
                                              <StatusBadge status={order.status}/>
                                          </div>
                                          <h4 className="font-bold text-lg mb-1 truncate text-stone-800 group-hover:text-emerald-700 transition-colors">{order.delivery?.name || 'Unknown'}</h4>
                                          <p className="text-2xl font-black text-stone-900">{formatINR(order.total)}</p>
                                          <p className="text-xs text-stone-400 mt-4 border-t border-stone-100 pt-3 flex items-center gap-1"><Clock className="w-3 h-3"/> {formatDate(order.createdAt)}</p>
                                      </div>
                                  ))}
                              </div>
                              {allOrders.length === 0 && <p className="text-center text-stone-400 py-20">No orders in the system.</p>}
                          </div>
                      )}

                      {/* SETTINGS TAB */}
                      {activeTab === 'settings' && (
                          <div className="max-w-md mx-auto better-box p-10 bg-white animate-in slide-up">
                              <h2 className="text-2xl font-bold mb-6 text-stone-900">Payment Configuration</h2>
                              <form onSubmit={handleSaveSettings} className="space-y-6">
                                  <Input label="Merchant UPI ID" value={paymentSettings.upiId} onChange={e => setPaymentSettings({...paymentSettings, upiId: e.target.value})} placeholder="merchant@upi" />
                                  
                                  <div className="border-2 border-dashed p-8 text-center rounded-2xl cursor-pointer hover:bg-stone-50 transition-colors relative border-stone-300">
                                      <QrCode className="w-10 h-10 text-stone-300 mx-auto mb-3"/>
                                      <p className="text-sm font-bold text-stone-600 mb-1">{qrFile ? qrFile.name : "Upload New QR Code"}</p>
                                      <p className="text-xs text-stone-400">PNG, JPG up to 2MB</p>
                                      <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={e => setQrFile(e.target.files[0])} />
                                  </div>
                                  
                                  <Button type="submit" disabled={savingSettings} variant="dark" className="w-full h-12 text-lg">
                                      {savingSettings ? <Spinner className="text-white"/> : "Save Configuration"}
                                  </Button>
                              </form>
                          </div>
                      )}

                      {/* --- MODALS FOR ADMIN --- */}
                      
                      {/* User Rejection Modal */}
                      <Modal isOpen={!!selectedUserReject} onClose={() => setSelectedUserReject(null)} title="Reject Application">
                          <textarea className="input-better h-32 mb-4" placeholder="Reason for rejection (will be shown to user)..." value={rejectReason} onChange={e => setRejectReason(e.target.value)}/>
                          <Button onClick={() => handleUserUpdate(selectedUserReject, {status:'rejected', rejectionReason:rejectReason})} variant="dangerSolid" fullWidth>Confirm Rejection</Button>
                      </Modal>

                      {/* Product Rejection Modal */}
                      <Modal isOpen={!!selectedProductReject} onClose={() => setSelectedProductReject(null)} title="Reject Product">
                          <textarea className="input-better h-32 mb-4" placeholder="Reason for rejection..." value={productRejectReason} onChange={e => setProductRejectReason(e.target.value)}/>
                          <Button onClick={() => handleProductUpdate(selectedProductReject, {status:'rejected', rejectionReason:productRejectReason})} variant="dangerSolid" fullWidth>Confirm Rejection</Button>
                      </Modal>

                      {/* Order Review Modal */}
                      {selectedOrderReview && (
                          <Modal isOpen={true} onClose={() => setSelectedOrderReview(null)} title="Order Verification" maxWidth="max-w-2xl">
                              <div className="flex flex-col md:flex-row gap-8">
                                  <div className="flex-1 space-y-4">
                                      <div className="bg-stone-50 p-4 rounded-xl border border-stone-100">
                                          <p className="text-xs text-stone-400 uppercase font-bold mb-1">Status</p>
                                          <StatusBadge status={selectedOrderReview.status}/>
                                      </div>
                                      <div className="bg-stone-50 p-4 rounded-xl border border-stone-100">
                                          <p className="text-xs text-stone-400 uppercase font-bold mb-1">Customer</p>
                                          <p className="font-bold text-stone-900">{selectedOrderReview.delivery?.name}</p>
                                          <p className="text-stone-500 font-mono text-sm">{selectedOrderReview.delivery?.phone}</p>
                                      </div>
                                      <div className="bg-stone-50 p-4 rounded-xl border border-stone-100">
                                          <p className="text-xs text-stone-400 uppercase font-bold mb-1">Amount Paid</p>
                                          <p className="text-3xl font-black text-emerald-700">{formatINR(selectedOrderReview.grandTotalPaid || selectedOrderReview.total)}</p>
                                      </div>
                                  </div>
                                  
                                  <div className="flex-1">
                                      <p className="text-xs font-bold text-stone-400 uppercase mb-3">Payment Screenshot</p>
                                      {selectedOrderReview.screenshotUrl ? (
                                          <a href={selectedOrderReview.screenshotUrl} target="_blank" className="block mb-6 group relative rounded-xl overflow-hidden border border-stone-200">
                                              <img src={selectedOrderForReview.screenshotUrl} className="w-full h-64 object-cover group-hover:opacity-90 transition-opacity" />
                                              <div className="absolute inset-0 flex items-center justify-center bg-black/30 opacity-0 group-hover:opacity-100 transition-opacity">
                                                  <ExternalLink className="text-white w-8 h-8"/>
                                              </div>
                                          </a>
                                      ) : (
                                          <div className="h-64 bg-stone-100 rounded-xl flex items-center justify-center text-stone-400 text-sm font-bold mb-6 border border-dashed border-stone-300">No Screenshot Uploaded</div>
                                      )}
                                      
                                      {selectedOrderReview.status === 'Payment Review' && (
                                          <div className="grid grid-cols-2 gap-3">
                                              <Button onClick={() => handleOrderVerification(selectedOrderReview.id, 'Payment Verified')} variant="primary" icon={CheckCircle}>Confirm</Button>
                                              <Button onClick={() => handleOrderVerification(selectedOrderReview.id, 'Payment Rejected')} variant="danger" icon={XCircle}>Reject</Button>
                                          </div>
                                      )}
                                  </div>
                              </div>
                          </Modal>
                      )}
                  </div>
              </div>
            );
          };

          // --- MAIN APP COMPONENT ---
          return (
            <AppProvider>
                <div className="font-sans text-stone-900 min-h-screen flex flex-col">
                    <MainContent />
                </div>
            </AppProvider>
          );
        }

        /**
         * Main Content Wrapper
         * Handles routing based on Context state.
         */
        const MainContent = () => {
            const { view, currentUser, loading, authMode, setAuthMode } = useGlobalState();
            
            // Handle Login Logic here to pass to AuthScreen
            // Note: In a larger app, AuthScreen would use context directly, but passing props keeps it explicit for this structure.
            const handleLogin = async (email, password) => {
                const { showNotification, setView } = useGlobalState(); // This hook call is invalid inside a nested function
                // ... logic moved to Context or handled via prop drilling for simplicity in single file
            };
            
            // To fix the hook rule above, we access context at top level:
            const { setView, showNotification } = useGlobalState();
            
            // Auth Handlers wrapping Firebase calls
            const loginUser = async (email, password) => {
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showNotification("Welcome back!", "success");
                    // Redirect handled by Auth Listener in Context
                } catch(e) {
                    showNotification("Invalid email or password.", "error");
                }
            };
            
            const signupUser = async (data, file) => {
               try {
                  const cred = await createUserWithEmailAndPassword(auth, data.email, data.password);
                  let docUrl = "";
                  if (file) docUrl = await uploadToCloudinary(file);
                  
                  let role = data.role;
                  let status = (role === 'farmer' || role === 'delivery') ? 'pending' : 'active';
                  if (MOD_EMAILS.includes(data.email.toLowerCase())) { role = 'mod'; status = 'active'; }
                  
                  await setDoc(getDocRef("users", cred.user.uid), {
                      ...data, role, status, docUrl, 
                      joinedDate: serverTimestamp(), rejectionCount: 0 
                  });
                  
                  showNotification("Account created successfully!", "success");
               } catch (e) {
                  showNotification(e.message, "error");
               }
            };

            if (loading) return <LoadingScreen />;

            return (
                <>
                    <Navbar />
                    <main className="flex-grow">
                        {view === 'home' && <Hero />}
                        {view === 'auth' && <AuthScreen authMode={authMode} setAuthMode={setAuthMode} handleLogin={loginUser} handleSignup={signupUser} loading={false} />}
                        
                        {/* Secured Routes */}
                        {view === 'farmer-panel' && currentUser?.role === 'farmer' && <FarmerDashboard />}
                        {view === 'delivery-panel' && currentUser?.role === 'delivery' && <DeliveryDashboard />}
                        {view === 'mod-panel' && currentUser?.role === 'mod' && <ModDashboard />}
                        
                        {/* Public/Buyer Routes */}
                        {view === 'marketplace' && <Marketplace />}
                        {view === 'my-orders' && <BuyerOrders />}
                        
                        {/* Static Pages */}
                        {view === 'about' && (
                            <div className="pt-40 px-4 max-w-4xl mx-auto text-center animate-in slide-up">
                                <span className="text-emerald-600 font-bold tracking-widest uppercase text-sm mb-4 block">Our Mission</span>
                                <h1 className="text-5xl font-display font-black mb-8 text-stone-900">Empowering Farmers,<br/>Nourishing Communities</h1>
                                <p className="text-xl text-stone-600 leading-relaxed">
                                    At Farm2Home, we are dedicated to revolutionizing the agricultural landscape. By cutting out the middlemen, we ensure that farmers receive fair compensation for their hard work, while you enjoy produce that is fresher, tastier, and more sustainable.
                                </p>
                            </div>
                        )}
                    </main>
                    {['home', 'marketplace', 'about'].includes(view) && <Footer />}
                </>
            );
        };

        // Render Application
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
