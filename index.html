<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Farm2Home - The premier marketplace connecting local farmers directly with consumers and delivery partners. Fresh, Organic, Sustainable.">
    <meta name="theme-color" content="#047857">
    <title>Farm2Home - Fresh Produce Marketplace</title>
    
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/726/726058.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        stone: {
                            50: '#fafaf9',
                            100: '#f5f5f4',
                            200: '#e7e5e4',
                            300: '#d6d3d1',
                            400: '#a8a29e',
                            500: '#78716c',
                            600: '#57534e',
                            700: '#44403c',
                            800: '#292524',
                            900: '#1c1917',
                            950: '#0c0a09',
                        },
                        emerald: {
                            50: '#ecfdf5',
                            100: '#d1fae5',
                            200: '#a7f3d0',
                            300: '#6ee7b7',
                            400: '#34d399',
                            500: '#10b981',
                            600: '#059669',
                            700: '#047857',
                            800: '#065f46',
                            900: '#064e3b',
                            950: '#022c22',
                        },
                        amber: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            500: '#f59e0b',
                            600: '#d97706',
                            700: '#b45309',
                        },
                        red: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                        }
                    },
                    fontFamily: {
                        sans: ['Outfit', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                        display: ['Plus Jakarta Sans', 'ui-sans-serif', 'system-ui'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                        'slide-in-right': 'slideInRight 0.4s ease-out forwards',
                        'bounce-slight': 'bounce 3s infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'spin-slow': 'spin 3s linear infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        slideInRight: {
                            '0%': { transform: 'translateX(100%)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(16, 185, 129, 0.3)',
                    }
                }
            }
        }
    </script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --glass-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
        }

        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: #FDFCF8; 
            color: #1C1917; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            letter-spacing: -0.025em;
        }

        /* --- Component Classes --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: var(--glass-border);
            box-shadow: var(--glass-shadow);
        }

        .better-box {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            border: 1px solid #F0FDF4; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .better-box:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.01);
            border-color: #86EFAC; 
        }

        /* Input Styling */
        .input-better {
            width: 100%;
            padding: 1rem 1.25rem;
            background-color: #FAFAF9; 
            border: 1px solid #E7E5E4; 
            border-radius: 1rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            color: #1C1917;
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .input-better:focus {
            background-color: white;
            border-color: #15803D; 
            box-shadow: 0 0 0 4px rgba(21, 128, 61, 0.1);
        }

        .input-better::placeholder {
            color: #A8A29E;
        }
        
        .input-error {
            border-color: #EF4444;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
        }

        /* Button Base Styles */
        .btn-base {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border-radius: 0.75rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .btn-base:active {
            transform: scale(0.98);
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #D6D3D1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #A8A29E;
        }

        /* Loading Dots Animation */
        .loader-dots::after {
            content: " .";
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: " ."; }
            40% { content: " .."; }
            60% { content: " ..."; }
            80%, 100% { content: ""; }
        }
    </style>
</head>
<body class="antialiased selection:bg-emerald-100 selection:text-emerald-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, createContext, useContext, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Leaf, Truck, ShieldCheck, Heart, Search, ShoppingCart, 
          User, ChevronRight, Menu, X, MapPin, Star, 
          Facebook, Twitter, Instagram, Upload, FileText, CheckCircle, 
          XCircle, AlertCircle, Package, DollarSign, Users, ClipboardList, 
          Loader2, QrCode, Image as ImageIcon, LayoutDashboard, Info, 
          Home, Mail, Trash2, Box, Edit2, AlertTriangle, Copy, Phone, 
          ExternalLink, Settings, Wallet, FileCheck, Bike, Headphones, RefreshCw, 
          Sprout, LogOut, Clock, Calendar, Plus, Minus, Store, Ban, 
          BarChart3, PieChart, TrendingUp, HelpCircle, Lock, ShoppingBag
        } from 'lucide-react';

        // --- 1. FIREBASE CONFIGURATION ---
        import { initializeApp } from 'firebase/app';
        import { 
          getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
          signOut, onAuthStateChanged, deleteUser, signInAnonymously,
          updateProfile
        } from 'firebase/auth';
        import { 
          getFirestore, collection, addDoc, getDocs, doc, setDoc, 
          getDoc, updateDoc, onSnapshot, query, where, serverTimestamp, 
          limit, orderBy, deleteDoc, increment
        } from 'firebase/firestore';

        const firebaseConfig = {
          apiKey: "AIzaSyCTV6gg2QXLHJMSGvOWIa-YDy5-PvrgeHk",
          authDomain: "farm2home-2f7ff.firebaseapp.com",
          projectId: "farm2home-2f7ff",
          storageBucket: "farm2home-2f7ff.firebasestorage.app",
          messagingSenderId: "656644623315",
          appId: "1:656644623315:web:0d59d865c82b5c9b4e7d26",
          measurementId: "G-XFQFK8Q9TZ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- 2. UTILITY FUNCTIONS ---
        const getCollection = (name) => collection(db, name);
        const getDocRef = (colName, docId) => doc(db, colName, docId);
        
        const uploadToCloudinary = async (file) => {
          const formData = new FormData();
          formData.append("file", file);
          formData.append("upload_preset", "Farm2Home");
          try {
              const res = await fetch("https://api.cloudinary.com/v1_1/drf5cbuzu/auto/upload", { method: "POST", body: formData });
              if (!res.ok) throw new Error("Image upload failed.");
              const data = await res.json();
              return data.secure_url;
          } catch (error) {
              console.error("Upload Error:", error);
              throw error;
          }
        };

        const formatINR = (number) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(number);

        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.seconds ? new Date(timestamp.seconds * 1000) : new Date(timestamp);
            return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        };

        const MOD_EMAILS = ['aadityabillawa@gmail.com', 'zeyamalam@gmail.com'];

        // --- 3. UI COMPONENT LIBRARY ---
        const Spinner = ({ size = "w-5 h-5", color = "text-current" }) => (
            <Loader2 className={`animate-spin ${size} ${color}`} />
        );

        const LoadingScreen = () => (
            <div className="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
                <Spinner size="w-12 h-12" color="text-emerald-600" />
                <p className="mt-4 text-stone-500 font-medium animate-pulse">Loading Farm2Home...</p>
            </div>
        );

        const Button = ({ children, onClick, variant = 'primary', size = 'md', className = '', disabled = false, type = 'button', icon: Icon, fullWidth = false }) => {
            const base = "font-bold rounded-xl transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2";
            const variants = {
                primary: "bg-emerald-700 text-white hover:bg-emerald-800 shadow-lg shadow-emerald-700/20",
                secondary: "bg-white text-stone-700 border border-stone-200 hover:bg-stone-50",
                outline: "bg-transparent border-2 border-emerald-600 text-emerald-700 hover:bg-emerald-50",
                danger: "bg-white text-red-600 border border-red-200 hover:bg-red-50",
                dangerSolid: "bg-red-600 text-white hover:bg-red-700 shadow-lg shadow-red-600/20",
                ghost: "bg-transparent text-stone-500 hover:text-stone-900 hover:bg-stone-100",
                dark: "bg-stone-900 text-white hover:bg-stone-800 shadow-lg"
            };
            const sizes = { sm: "px-3 py-1.5 text-xs", md: "px-6 py-3 text-sm", lg: "px-8 py-4 text-lg" };
            return (
                <button type={type} onClick={onClick} disabled={disabled} className={`${base} ${variants[variant]} ${sizes[size]} ${fullWidth ? 'w-full' : ''} ${className}`}>
                    {Icon && <Icon className={size === 'sm' ? "w-3 h-3" : "w-4 h-4"} />}
                    {children}
                </button>
            );
        };

        const Input = ({ label, error, icon: Icon, ...props }) => (
            <div className="w-full">
                {label && <label className="block text-xs font-bold text-stone-500 uppercase mb-1.5 ml-1">{label}</label>}
                <div className="relative">
                    {Icon && <Icon className="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-stone-400 pointer-events-none"/>}
                    <input className={`w-full ${Icon ? 'pl-10' : 'px-4'} py-3 rounded-xl bg-stone-50 border ${error ? 'border-red-300 ring-2 ring-red-100' : 'border-stone-200'} focus:bg-white focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10 transition-all outline-none text-stone-800 font-medium placeholder-stone-400`} {...props} />
                </div>
                {error && <p className="text-xs text-red-500 mt-1 ml-1 font-bold flex items-center gap-1"><AlertCircle className="w-3 h-3"/> {error}</p>}
            </div>
        );

        const Select = ({ label, options, ...props }) => (
            <div className="w-full">
                {label && <label className="block text-xs font-bold text-stone-500 uppercase mb-1.5 ml-1">{label}</label>}
                <div className="relative">
                    <select className="w-full px-4 py-3 rounded-xl bg-stone-50 border border-stone-200 focus:bg-white focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10 transition-all outline-none text-stone-800 font-medium appearance-none cursor-pointer" {...props}>
                        {options.map(opt => (<option key={opt.value} value={opt.value}>{opt.label}</option>))}
                    </select>
                    <ChevronRight className="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-stone-400 rotate-90 pointer-events-none"/>
                </div>
            </div>
        );

        const Textarea = ({ label, ...props }) => (
            <div className="w-full">
                {label && <label className="block text-xs font-bold text-stone-500 uppercase mb-1.5 ml-1">{label}</label>}
                <textarea className="w-full px-4 py-3 rounded-xl bg-stone-50 border border-stone-200 focus:bg-white focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10 transition-all outline-none text-stone-800 font-medium resize-none min-h-[100px]" {...props} />
            </div>
        );

        const StatusBadge = ({ status }) => {
            const styles = {
                'pending': 'bg-amber-100 text-amber-800 border-amber-200',
                'active': 'bg-emerald-100 text-emerald-800 border-emerald-200',
                'approved': 'bg-emerald-100 text-emerald-800 border-emerald-200',
                'rejected': 'bg-red-100 text-red-800 border-red-200',
                'suspended': 'bg-stone-800 text-white border-stone-900',
                'Payment Review': 'bg-amber-100 text-amber-800 border-amber-200',
                'Payment Verified': 'bg-blue-100 text-blue-800 border-blue-200',
                'Payment Rejected': 'bg-red-100 text-red-800 border-red-200',
                'Confirmed by Farmer': 'bg-indigo-100 text-indigo-800 border-indigo-200',
                'Preparing': 'bg-indigo-100 text-indigo-800 border-indigo-200',
                'Ready for Pickup': 'bg-teal-100 text-teal-800 border-teal-200',
                'Out for Delivery': 'bg-purple-100 text-purple-800 border-purple-200',
                'Delivered': 'bg-green-100 text-green-800 border-green-200',
            };
            let BadgeIcon = Info;
            if (status === 'Delivered' || status === 'approved' || status === 'Payment Verified') BadgeIcon = CheckCircle;
            if (status === 'Payment Review' || status === 'pending') BadgeIcon = Clock;
            if (status === 'Out for Delivery') BadgeIcon = Bike;
            if (status === 'rejected' || status === 'Payment Rejected') BadgeIcon = XCircle;

            return (
                <span className={`inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wide border ${styles[status] || 'bg-stone-100 text-stone-500'}`}>
                    <BadgeIcon className="w-3 h-3" />
                    {status}
                </span>
            );
        };

        const NotificationToast = ({ msg, type, onClose }) => (
            <div className={`fixed bottom-6 right-6 z-[100] px-6 py-4 rounded-2xl text-white font-bold shadow-2xl animate-in slide-in-from-bottom-10 fade-in duration-300 flex items-center gap-3 ${type === 'error' ? 'bg-red-600' : 'bg-emerald-700'}`}>
                {type === 'error' ? <AlertTriangle className="w-5 h-5"/> : <CheckCircle className="w-5 h-5"/>}
                <span className="text-sm tracking-wide">{msg}</span>
                <button onClick={onClose} className="ml-4 hover:bg-white/20 p-1 rounded-full transition-colors"><X className="w-4 h-4"/></button>
            </div>
        );

        const Modal = ({ isOpen, onClose, title, children, maxWidth = "max-w-md" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-stone-900/60 backdrop-blur-md animate-in fade-in duration-200" onClick={onClose}>
                    <div className={`bg-white rounded-[2rem] w-full ${maxWidth} shadow-2xl scale-100 animate-in zoom-in-95 duration-200 border border-stone-100 relative overflow-hidden flex flex-col max-h-[90vh]`} onClick={e => e.stopPropagation()}>
                        <div className="p-6 border-b border-stone-100 flex justify-between items-center bg-white sticky top-0 z-10">
                            <h3 className="text-2xl font-bold text-stone-900 tracking-tight">{title}</h3>
                            <button onClick={onClose} className="p-2 bg-stone-50 rounded-full hover:bg-stone-200 transition-colors"><X className="w-5 h-5 text-stone-500"/></button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar">{children}</div>
                    </div>
                </div>
            );
        };

        const ConfirmDialog = ({ isOpen, title, message, onConfirm, onCancel, confirmText = "Confirm", isDangerous = false }) => {
            if (!isOpen) return null;
            return (
                <Modal isOpen={isOpen} onClose={onCancel} title={title}>
                    <div className="flex flex-col items-center text-center">
                        <div className={`w-16 h-16 rounded-full flex items-center justify-center mb-6 ${isDangerous ? 'bg-red-50 text-red-500' : 'bg-emerald-50 text-emerald-600'}`}>
                            {isDangerous ? <AlertTriangle className="w-8 h-8"/> : <Info className="w-8 h-8"/>}
                        </div>
                        <p className="text-stone-500 mb-8 leading-relaxed">{message}</p>
                        <div className="flex gap-3 w-full">
                            <Button variant="secondary" onClick={onCancel} className="flex-1">Cancel</Button>
                            <Button variant={isDangerous ? "dangerSolid" : "primary"} onClick={onConfirm} className="flex-1">{confirmText}</Button>
                        </div>
                    </div>
                </Modal>
            );
        };

        // --- 4. STATE MANAGEMENT ---
        const AppContext = createContext();

        const AppProvider = ({ children }) => {
            const [currentUser, setCurrentUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [notification, setNotification] = useState(null);
            const [cart, setCart] = useState([]);
            const [view, setView] = useState(() => localStorage.getItem('farm2home_view') || 'home');
            const [authMode, setAuthMode] = useState('login');

            const showNotification = useCallback((msg, type = 'success') => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 4000);
            }, []);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        try {
                            const userDocRef = getDocRef("users", user.uid);
                            const userDoc = await getDoc(userDocRef);
                            if (userDoc.exists()) {
                                const userData = userDoc.data();
                                if (MOD_EMAILS.includes(user.email.toLowerCase()) && userData.role !== 'mod') {
                                    await updateDoc(userDocRef, { role: 'mod', status: 'active' });
                                    userData.role = 'mod';
                                }
                                setCurrentUser({ uid: user.uid, ...userData });
                            } else {
                                setCurrentUser({ uid: user.uid, role: 'unknown', name: user.email });
                            }
                        } catch (error) {
                            showNotification("Error loading profile. Please refresh.", "error");
                        }
                    } else {
                        setCurrentUser(null);
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [showNotification]);

            useEffect(() => {
                localStorage.setItem('farm2home_view', view);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, [view]);

            useEffect(() => {
                const savedCart = localStorage.getItem('farm2home_cart');
                if (savedCart) {
                    try { setCart(JSON.parse(savedCart)); } catch (e) {}
                }
            }, []);

            useEffect(() => { localStorage.setItem('farm2home_cart', JSON.stringify(cart)); }, [cart]);

            const addToCart = (product) => {
                if (!currentUser) {
                    showNotification("Please login to start shopping.", "error");
                    setView('auth');
                    setAuthMode('login');
                    return;
                }
                if (product.stock <= 0) {
                    showNotification("Sorry, this item is out of stock.", "error");
                    return;
                }
                setCart(prev => {
                    const existingItem = prev.find(item => item.id === product.id);
                    if (existingItem) {
                        if (existingItem.quantity >= product.stock) {
                            showNotification(`Only ${product.stock} units available.`, "error");
                            return prev;
                        }
                        showNotification(`${product.name} quantity updated.`, "success");
                        return prev.map(item => item.id === product.id ? { ...item, quantity: item.quantity + 1 } : item);
                    }
                    showNotification(`${product.name} added to cart.`, "success");
                    return [...prev, { ...product, quantity: 1 }];
                });
            };

            const removeFromCart = (productId) => {
                setCart(prev => prev.filter(item => item.id !== productId));
                showNotification("Item removed from basket.", "success");
            };

            const updateCartQuantity = (productId, delta) => {
                setCart(prev => prev.map(item => {
                    if (item.id === productId) {
                        const newQuantity = Math.max(0, item.quantity + delta);
                        if (newQuantity === 0) return null;
                        if (newQuantity > item.stock) {
                            showNotification("Cannot exceed available stock.", "error");
                            return item;
                        }
                        return { ...item, quantity: newQuantity };
                    }
                    return item;
                }).filter(Boolean));
            };

            const clearCart = () => setCart([]);

            const handleLogout = async () => {
                try {
                    await signOut(auth);
                    setCart([]);
                    localStorage.removeItem('farm2home_view');
                    setView('home');
                    showNotification("Successfully logged out.", "success");
                } catch (error) { console.error("Logout Error:", error); }
            };

            const value = {
                currentUser, loading, notification, showNotification, view, setView,
                authMode, setAuthMode, cart, addToCart, removeFromCart,
                updateCartQuantity, clearCart, handleLogout
            };

            return (
                <AppContext.Provider value={value}>
                    {children}
                    {notification && (
                        <NotificationToast msg={notification.msg} type={notification.type} onClose={() => setNotification(null)} />
                    )}
                </AppContext.Provider>
            );
        };
        const useGlobalState = () => useContext(AppContext);

        // --- 5. CORE LAYOUT COMPONENTS ---
        const Navbar = () => {
            const { currentUser, view, setView, handleLogout, setAuthMode, cart } = useGlobalState();
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [scrolled, setScrolled] = useState(false);
            const cartCount = cart.reduce((acc, item) => acc + item.quantity, 0);

            useEffect(() => {
                const handleScroll = () => setScrolled(window.scrollY > 20);
                window.addEventListener('scroll', handleScroll);
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            const NavButton = ({ target, label, icon: Icon }) => (
                <button onClick={() => { setView(target); setIsMenuOpen(false); }}
                    className={`flex items-center gap-2 px-4 py-2 rounded-xl transition-all duration-200 ${view === target ? 'bg-emerald-50 text-emerald-700 font-bold' : 'text-stone-500 hover:bg-stone-50 hover:text-stone-900 font-medium'}`}>
                    {Icon && <Icon className="w-4 h-4" />} {label}
                </button>
            );

            return (
                <nav className={`fixed top-0 left-0 right-0 z-50 transition-all duration-300 ${scrolled ? 'bg-white/90 backdrop-blur-xl shadow-sm h-16' : 'bg-transparent h-24'}`}>
                    <div className="max-w-7xl mx-auto px-4 h-full flex justify-between items-center">
                        <div className="flex items-center gap-3 cursor-pointer group" onClick={() => setView('home')}>
                            <div className="bg-gradient-to-br from-emerald-600 to-teal-500 p-2.5 rounded-xl shadow-lg shadow-emerald-500/20 group-hover:scale-105 transition-transform duration-300">
                                <Leaf className="text-white w-6 h-6" />
                            </div>
                            <div className="flex flex-col">
                                <span className="text-2xl font-bold text-stone-800 tracking-tight leading-none">Farm<span className="text-emerald-600">2</span>Home</span>
                                <span className="text-[10px] font-bold text-stone-400 uppercase tracking-widest leading-none mt-0.5">Fresh Market</span>
                            </div>
                        </div>

                        <div className="hidden md:flex items-center gap-2">
                            <NavButton target="home" label="Home" />
                            <NavButton target="marketplace" label="Shop" />
                            <NavButton target="about" label="Our Story" />
                        </div>

                        <div className="hidden md:flex items-center gap-4">
                            {/* Shopping Cart Trigger */}
                            {cart.length > 0 && (
                                <button onClick={() => setView('checkout')} className="relative p-2 bg-emerald-50 text-emerald-600 rounded-full hover:bg-emerald-100 transition-colors">
                                    <ShoppingCart className="w-5 h-5"/>
                                    <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full font-bold shadow-sm">{cartCount}</span>
                                </button>
                            )}

                            {!currentUser ? (
                                <div className="flex items-center gap-3">
                                    <button onClick={() => { setView('auth'); setAuthMode('login'); }} className="text-stone-600 font-bold hover:text-emerald-700 px-4 py-2 transition-colors">Sign In</button>
                                    <Button onClick={() => { setView('auth'); setAuthMode('signup'); }} variant="primary" size="md" className="shadow-emerald-500/25">Get Started</Button>
                                </div>
                            ) : (
                                <div className="flex items-center gap-3">
                                    {currentUser.role === 'farmer' && <Button variant="primary" size="sm" onClick={() => setView('farmer-panel')} icon={LayoutDashboard} className="bg-emerald-100 text-emerald-800 hover:bg-emerald-200 border border-emerald-200 shadow-none">Farmer Dashboard</Button>}
                                    {currentUser.role === 'delivery' && <Button variant="primary" size="sm" onClick={() => setView('delivery-panel')} icon={Bike} className="bg-orange-100 text-orange-800 hover:bg-orange-200 border border-orange-200 shadow-none">Delivery Panel</Button>}
                                    {currentUser.role === 'mod' && <Button variant="primary" size="sm" onClick={() => setView('mod-panel')} icon={ShieldCheck} className="bg-purple-100 text-purple-800 hover:bg-purple-200 border border-purple-200 shadow-none">Admin</Button>}
                                    <Button variant="secondary" size="sm" onClick={() => setView('my-orders')} icon={Package}>My Orders</Button>
                                    <div className="h-8 w-px bg-stone-200 mx-2"></div>
                                    <div className="flex items-center gap-3 group relative">
                                        <div className="text-right hidden lg:block">
                                            <p className="text-sm font-bold text-stone-900 leading-none">{currentUser.name.split(' ')[0]}</p>
                                            <p className="text-[10px] font-bold text-stone-400 uppercase leading-none mt-1">{currentUser.role}</p>
                                        </div>
                                        <div className="w-10 h-10 rounded-full bg-gradient-to-tr from-stone-800 to-stone-700 text-white flex items-center justify-center font-bold shadow-md ring-2 ring-white cursor-pointer hover:ring-emerald-200 transition-all">
                                            {currentUser.name ? currentUser.name.charAt(0).toUpperCase() : <User className="w-5 h-5"/>}
                                        </div>
                                        <div className="absolute right-0 top-full mt-2 w-48 bg-white rounded-xl shadow-xl border border-stone-100 p-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all transform translate-y-2 group-hover:translate-y-0">
                                            <button onClick={handleLogout} className="w-full text-left px-4 py-2 rounded-lg text-sm font-bold text-red-600 hover:bg-red-50 flex items-center gap-2"><LogOut className="w-4 h-4"/> Sign Out</button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                        <button className="md:hidden text-stone-800 p-2" onClick={() => setIsMenuOpen(!isMenuOpen)}>{isMenuOpen ? <X /> : <Menu />}</button>
                    </div>
                    {isMenuOpen && (
                        <div className="absolute top-full left-0 right-0 bg-white border-b border-stone-100 p-4 shadow-xl md:hidden flex flex-col gap-2 animate-slide-up">
                            <NavButton target="home" label="Home" icon={Home}/>
                            <NavButton target="marketplace" label="Shop Produce" icon={Store}/>
                            <NavButton target="about" label="Our Mission" icon={Info}/>
                            <div className="h-px bg-stone-100 my-2"></div>
                            {currentUser ? (
                                <>
                                    {currentUser.role === 'farmer' && <NavButton target="farmer-panel" label="Farmer Dashboard" icon={LayoutDashboard}/>}
                                    {currentUser.role === 'delivery' && <NavButton target="delivery-panel" label="Delivery Panel" icon={Bike}/>}
                                    {currentUser.role === 'mod' && <NavButton target="mod-panel" label="Admin Console" icon={ShieldCheck}/>}
                                    <NavButton target="my-orders" label="My Purchases" icon={Package}/>
                                    <button onClick={handleLogout} className="flex items-center gap-2 px-4 py-3 rounded-xl bg-red-50 text-red-600 font-bold text-sm"><LogOut className="w-4 h-4"/> Sign Out</button>
                                </>
                            ) : (
                                <div className="flex flex-col gap-2">
                                    <Button onClick={() => { setView('auth'); setAuthMode('login'); setIsMenuOpen(false); }} variant="secondary" fullWidth>Sign In</Button>
                                    <Button onClick={() => { setView('auth'); setAuthMode('signup'); setIsMenuOpen(false); }} variant="primary" fullWidth>Create Account</Button>
                                </div>
                            )}
                        </div>
                    )}
                </nav>
            );
        };

        const Footer = () => {
            const { setView, setAuthMode } = useGlobalState();
            const FooterLink = ({ label, onClick }) => (<li><button onClick={onClick} className="text-stone-400 hover:text-emerald-400 transition-colors text-sm text-left">{label}</button></li>);
            return (
                <footer className="bg-stone-900 text-stone-400 py-20 mt-auto border-t border-stone-800">
                    <div className="max-w-7xl mx-auto px-4">
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-12 mb-16">
                            <div className="col-span-1 md:col-span-2">
                                <div className="flex items-center gap-2 mb-6 text-white">
                                    <div className="bg-emerald-900/50 p-2 rounded-lg border border-emerald-800"><Leaf className="text-emerald-500 w-6 h-6" /></div>
                                    <span className="text-2xl font-bold">Farm<span className="text-emerald-500">2</span>Home</span>
                                </div>
                                <p className="leading-relaxed mb-8 max-w-sm text-stone-400 text-sm">Bridging the gap between the earth's bounty and your dining table.</p>
                                <div className="flex gap-4">
                                    {['Facebook', 'Twitter', 'Instagram'].map(social => (<button key={social} className="w-10 h-10 rounded-full bg-stone-800 flex items-center justify-center text-stone-400 hover:bg-emerald-600 hover:text-white transition-all transform hover:-translate-y-1"><Twitter className="w-5 h-5"/></button>))}
                                </div>
                            </div>
                            <div>
                                <h4 className="font-bold text-white mb-6 uppercase tracking-wider text-xs">Platform</h4>
                                <ul className="space-y-3">
                                    <FooterLink label="Home" onClick={() => setView('home')} />
                                    <FooterLink label="Shop Produce" onClick={() => setView('marketplace')} />
                                    <li className="pt-2"><span className="text-xs font-bold text-stone-600 uppercase">Join Us</span></li>
                                    <FooterLink label="Become a Farmer" onClick={() => { setView('auth'); setAuthMode('signup'); }} />
                                    <FooterLink label="Become a Delivery Partner" onClick={() => { setView('auth'); setAuthMode('signup'); }} />
                                </ul>
                            </div>
                        </div>
                    </div>
                </footer>
            );
        };

        const AuthScreen = ({ authMode, setAuthMode, handleLogin, handleSignup, loading }) => {
             const [role, setRole] = useState('buyer'); 
             const [file, setFile] = useState(null);
             const [formData, setFormData] = useState({ name: '', email: '', password: '', phone: '', address: '', aadhar: '', vehicleName: '', vehicleNumber: '' });
             const handleSubmit = (e) => {
               e.preventDefault();
               if (authMode === 'login') handleLogin(formData.email, formData.password);
               else handleSignup({ ...formData, role }, file);
             };

             return (
               <div className="min-h-screen pt-20 flex bg-[#FDFCF8]">
                 <div className="hidden lg:flex w-1/2 bg-stone-900 relative items-center justify-center overflow-hidden">
                    <div className="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1500937386664-56d1dfef3854?q=80&w=1740')] bg-cover bg-center opacity-60 mix-blend-overlay"></div>
                    <div className="absolute inset-0 bg-gradient-to-t from-stone-900/90 to-transparent"></div>
                    <div className="relative z-10 p-16 text-white max-w-2xl">
                        <div className="inline-flex items-center gap-2 bg-emerald-500/20 backdrop-blur-md px-4 py-2 rounded-full border border-emerald-500/30 mb-8 animate-in slide-in-from-left-4 duration-700 delay-100">
                            <Sprout className="w-5 h-5 text-emerald-400" />
                            <span className="font-bold tracking-wide text-sm text-emerald-50">Direct From Soil</span>
                        </div>
                        <h1 className="text-6xl font-display font-bold mb-6 leading-tight animate-in slide-in-from-left-4 duration-700 delay-200">The Future of <span className="text-emerald-400">Food</span> is Local.</h1>
                        <p className="text-xl text-stone-300 leading-relaxed max-w-lg font-light animate-in slide-in-from-left-4 duration-700 delay-300">Join a thriving ecosystem where farmers get fair value, drivers earn flexibly, and families get the purest nutrition.</p>
                    </div>
                 </div>
                 <div className="w-full lg:w-1/2 flex items-center justify-center p-8 lg:p-16 overflow-y-auto">
                   <div className="w-full max-w-md animate-in slide-in-from-right-10 duration-500">
                       <div className="mb-10 text-center lg:text-left">
                           <h2 className="text-4xl font-bold text-stone-900 mb-3 font-display">{authMode === 'login' ? 'Welcome Back' : 'Join the Movement'}</h2>
                           <p className="text-stone-500">Access the freshest marketplace today.</p>
                       </div>
                       <form onSubmit={handleSubmit} className="space-y-6">
                         {authMode === 'signup' && (
                           <div className="grid grid-cols-3 gap-2 p-1.5 bg-stone-100 rounded-2xl mb-6">
                               {['buyer', 'farmer', 'delivery'].map((r) => (
                                   <button key={r} type="button" onClick={() => setRole(r)} className={`py-3 text-xs font-bold rounded-xl capitalize transition-all duration-300 ${role === r ? 'bg-white text-emerald-700 shadow-sm ring-1 ring-black/5' : 'text-stone-500 hover:text-stone-700'}`}>{r === 'delivery' ? 'Driver' : r}</button>
                               ))}
                           </div>
                         )}
                         {authMode === 'signup' && (
                             <div className="space-y-4 animate-in fade-in">
                                 <Input required placeholder="Full Name" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                                 <div className="relative">
                                     <div className="absolute left-4 top-1/2 -translate-y-1/2 font-bold text-stone-400 border-r border-stone-200 pr-3 text-sm select-none pointer-events-none">+91</div>
                                     <input required placeholder="Mobile Number" className="input-better pl-16" value={formData.phone} maxLength={10} onChange={e => { const val = e.target.value.replace(/\D/g, '').slice(0, 10); setFormData({...formData, phone: val}); }} />
                                 </div>
                                 {role === 'farmer' && <Input required placeholder="Farm Location / Address" value={formData.address} onChange={e => setFormData({...formData, address: e.target.value})} />}
                                 {role === 'delivery' && (
                                     <div className="grid grid-cols-2 gap-4 animate-in fade-in">
                                        <Input required placeholder="Vehicle Name" value={formData.vehicleName} onChange={e => setFormData({...formData, vehicleName: e.target.value})} />
                                        <Input required placeholder="Vehicle Number" value={formData.vehicleNumber} onChange={e => setFormData({...formData, vehicleNumber: e.target.value})} />
                                     </div>
                                 )}
                             </div>
                         )}
                         <div className="space-y-4">
                             <Input required type="email" placeholder="Email Address" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} />
                             <Input required type="password" placeholder="Password" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} />
                         </div>
                         {authMode === 'signup' && (role === 'farmer' || role === 'delivery') && (
                             <div className="bg-emerald-50/50 p-6 rounded-3xl border border-emerald-100 space-y-4 mt-4 animate-in fade-in">
                                 <div className="flex items-center gap-2 text-emerald-800 font-bold text-sm uppercase tracking-wide"><ShieldCheck className="w-4 h-4" /> Identity Verification</div>
                                 <Input required placeholder="Aadhar Number" className="bg-white" value={formData.aadhar} onChange={e => setFormData({...formData, aadhar: e.target.value})} />
                                 <div className="border-2 border-dashed border-emerald-200 p-6 text-center rounded-2xl cursor-pointer relative hover:bg-emerald-50 transition-colors group bg-white/50">
                                     <Upload className="w-8 h-8 text-emerald-400 mx-auto mb-2 group-hover:scale-110 transition-transform"/>
                                     <span className="text-sm font-bold text-stone-600 block">{file ? file.name : "Upload Government ID"}</span>
                                     <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={e => setFile(e.target.files[0])} />
                                 </div>
                             </div>
                         )}
                         <Button type="submit" variant="primary" size="lg" className="w-full mt-6 text-lg" disabled={loading}>
                             {loading ? <Spinner className="text-white"/> : (authMode === 'login' ? 'Sign In' : 'Create Account')}
                         </Button>
                       </form>
                       <div className="mt-8 text-center">
                           <button onClick={() => setAuthMode(authMode === 'login' ? 'signup' : 'login')} className="text-stone-500 font-medium hover:text-emerald-700 transition-colors">{authMode === 'login' ? "New to Farm2Home? Create an Account" : "Already a member? Sign In"}</button>
                       </div>
                   </div>
                 </div>
               </div>
             );
        };

        const Hero = () => {
             const { setView } = useGlobalState();
             return (
                <div className="relative pt-32 pb-20 lg:pt-48 lg:pb-32 overflow-hidden">
                    <div className="absolute top-0 right-0 w-1/2 h-full bg-emerald-50/50 skew-x-12 transform origin-top-right -z-10"></div>
                    <div className="max-w-7xl mx-auto px-4 flex flex-col items-center text-center">
                        <div className="inline-flex items-center gap-2 bg-white px-4 py-2 rounded-full border border-stone-200 shadow-sm mb-8 animate-in slide-up">
                            <span className="flex h-2 w-2 rounded-full bg-emerald-500"></span>
                            <span className="text-xs font-bold text-stone-600 uppercase tracking-wide">Connecting 500+ Local Farms</span>
                        </div>
                        <h1 className="text-5xl lg:text-7xl font-display font-black text-stone-900 mb-8 tracking-tight max-w-4xl mx-auto animate-in slide-up delay-100">
                            Fresh from the <span className="text-transparent bg-clip-text bg-gradient-to-r from-emerald-600 to-teal-500">Harvest</span> to your <span className="text-stone-900">Doorstep.</span>
                        </h1>
                        <p className="text-xl text-stone-500 mb-12 max-w-2xl mx-auto leading-relaxed animate-in slide-up delay-200">
                            Experience the true taste of nature. We connect you directly with local farmers, ensuring fair prices and the freshest organic produce delivered within hours.
                        </p>
                        <div className="flex gap-4 animate-in slide-up delay-300">
                            <Button onClick={() => setView('marketplace')} variant="primary" size="lg" className="shadow-emerald-500/30" icon={ShoppingBag}>Start Shopping</Button>
                            <Button onClick={() => setView('about')} variant="secondary" size="lg">Learn More</Button>
                        </div>
                    </div>
                </div>
             );
        };

        const Marketplace = () => {
            const { addToCart } = useGlobalState();
            const [products, setProducts] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const q = query(getCollection("products"), where("status", "==", "approved"));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setProducts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            if(loading) return <div className="min-h-screen pt-32 flex justify-center"><Spinner size="w-8 h-8"/></div>;

            return (
                <div className="min-h-screen pt-28 px-4 pb-20 max-w-7xl mx-auto">
                    <div className="text-center mb-16">
                        <h2 className="text-4xl font-display font-black text-stone-900 mb-4">Fresh Market</h2>
                        <p className="text-stone-500">Directly from our verified local farmers</p>
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                        {products.map(product => (
                            <div key={product.id} className="better-box group flex flex-col h-full">
                                <div className="aspect-square bg-stone-100 relative overflow-hidden">
                                    <img src={product.imageUrl} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"/>
                                    {product.pesticides && <span className="absolute top-4 left-4 bg-emerald-500 text-white text-[10px] font-bold px-2 py-1 rounded shadow-lg">ORGANIC</span>}
                                </div>
                                <div className="p-6 flex flex-col flex-grow">
                                    <div className="mb-4">
                                        <h3 className="font-bold text-lg text-stone-900 mb-1">{product.name}</h3>
                                        <p className="text-xs text-stone-500">by {product.farmerName}</p>
                                    </div>
                                    <div className="flex items-center justify-between mt-auto">
                                        <div>
                                            <p className="text-lg font-black text-emerald-700">{formatINR(product.price)}</p>
                                            <p className="text-xs text-stone-400">per {product.unit}</p>
                                        </div>
                                        <button onClick={() => addToCart(product)} className="w-10 h-10 rounded-full bg-stone-900 text-white flex items-center justify-center hover:bg-emerald-600 transition-colors shadow-lg">
                                            <Plus className="w-5 h-5"/>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const BuyerOrders = () => {
            const { currentUser, setView } = useGlobalState();
            const [orders, setOrders] = useState([]);
            const [loadingOrders, setLoadingOrders] = useState(true);

            useEffect(() => {
                if (!currentUser) return;
                const q = query(getCollection("orders"), where("customerId", "==", currentUser.uid));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    items.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setOrders(items);
                    setLoadingOrders(false);
                });
                return () => unsubscribe();
            }, [currentUser]);

            if (loadingOrders) return <div className="min-h-screen pt-28 flex justify-center"><Spinner size="w-8 h-8" color="text-emerald-600"/></div>;

            return (
                <div className="min-h-screen pt-28 pb-12 px-4 bg-stone-50 animate-in fade-in">
                    <div className="max-w-4xl mx-auto">
                        <div className="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
                            <div>
                                <h1 className="text-4xl font-display font-black text-stone-900 tracking-tight">My Purchases</h1>
                                <p className="text-stone-500 mt-2">Track your fresh deliveries from farm to door.</p>
                            </div>
                            <Button onClick={() => setView('marketplace')} variant="primary" icon={Store} className="shadow-lg">Browse Shop</Button>
                        </div>
                        <div className="space-y-6">
                            {orders.length === 0 && (
                                <div className="text-center py-24 bg-white rounded-[2rem] border border-dashed border-stone-200 shadow-sm flex flex-col items-center">
                                    <div className="w-20 h-20 bg-stone-50 rounded-full flex items-center justify-center mb-6 text-stone-300"><Package className="w-10 h-10"/></div>
                                    <h3 className="text-xl font-bold text-stone-800 mb-2">No orders yet</h3>
                                    <Button onClick={() => setView('marketplace')} variant="secondary">Start Shopping</Button>
                                </div>
                            )}
                            {orders.map(order => (
                                <div key={order.id} className="better-box p-0 bg-white relative overflow-hidden group">
                                    <div className="p-6 md:p-8 border-b border-stone-100 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-white z-10 relative">
                                        <div>
                                            <div className="flex items-center gap-3 mb-2">
                                                <h3 className="font-bold text-xl text-stone-900">Order #{order.id.slice(0,6).toUpperCase()}</h3>
                                                <StatusBadge status={order.status}/>
                                            </div>
                                            <p className="text-xs text-stone-400 font-mono flex items-center gap-2"><Calendar className="w-3 h-3"/> {formatDate(order.createdAt)}</p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-xs font-bold text-stone-400 uppercase tracking-wide mb-1">Total Paid</p>
                                            <p className="text-2xl font-black text-stone-900">{formatINR(order.total)}</p>
                                        </div>
                                    </div>
                                    <div className="p-6 md:p-8 grid md:grid-cols-2 gap-8 md:gap-12">
                                        <div className="space-y-4">
                                            <h4 className="font-bold text-stone-900 text-xs uppercase tracking-wider flex items-center gap-2"><ShoppingBag className="w-3 h-3"/> Items Ordered</h4>
                                            <div className="space-y-3">
                                                {(order.items || []).map((item, idx) => (
                                                    <div key={idx} className="flex justify-between items-center text-sm p-3 bg-stone-50 rounded-xl">
                                                        <div className="flex flex-col"><span className="font-bold text-stone-800">{item.name}</span><span className="text-stone-500 text-xs">Qty: {item.quantity} {item.unit}</span></div>
                                                        <span className="font-bold text-stone-900">{formatINR(item.price * item.quantity)}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="space-y-4">
                                            <h4 className="font-bold text-stone-900 text-xs uppercase tracking-wider flex items-center gap-2"><Truck className="w-3 h-3"/> Delivery Info</h4>
                                            <div className="bg-stone-50 p-5 rounded-2xl space-y-4 text-sm text-stone-600 border border-stone-100">
                                                <div className="flex items-start gap-3">
                                                    <div className="w-8 h-8 rounded-full bg-white border border-stone-200 flex items-center justify-center shrink-0 shadow-sm"><MapPin className="w-4 h-4 text-emerald-600"/></div> 
                                                    <div><p className="font-bold text-stone-900 text-xs uppercase mb-1">Shipping Address</p><p className="leading-snug">{order.delivery?.address}</p></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const CheckoutModal = ({ onClose, onConfirm }) => {
             const { cart, currentUser, showNotification } = useGlobalState();
             const [uploading, setUploading] = useState(false);
             const [error, setError] = useState(""); 
             const [screenshot, setScreenshot] = useState(null);
             const [adminPaymentSettings, setAdminPaymentSettings] = useState(null);
             const [delivery, setDelivery] = useState({ name: currentUser?.name || '', email: currentUser?.email || '', phone: currentUser?.phone || '', address: currentUser?.address || '', state: '', zip: '' });

             useEffect(() => {
                const fetchSettings = async () => {
                    try { const snap = await getDoc(getDocRef("settings", "payment")); if (snap.exists()) setAdminPaymentSettings(snap.data()); } catch(e) {}
                };
                fetchSettings();
             }, []);

             const subtotal = useMemo(() => cart.reduce((sum, i) => sum + (i.price * i.quantity), 0), [cart]);
             const deliveryFee = 60;
             const grandTotal = subtotal + deliveryFee;

             const handleConfirm = async () => {
                 if (!screenshot) return setError("Please upload the payment screenshot to proceed.");
                 if (!delivery.address || !delivery.phone || !delivery.zip) return setError("Please fill in all shipping details.");
                 setUploading(true);
                 setError("");
                 try {
                     const ssUrl = await uploadToCloudinary(screenshot);
                     const groups = {};
                     cart.forEach(item => { if (!groups[item.farmerId]) groups[item.farmerId] = []; groups[item.farmerId].push(item); });
                     const batchPromises = Object.keys(groups).map(async (farmerId) => {
                         const items = groups[farmerId];
                         const portionTotal = items.reduce((s, i) => s + (i.price * i.quantity), 0);
                         return addDoc(getCollection("orders"), { farmerId, customerId: currentUser.uid, delivery, items, subtotal: portionTotal, total: portionTotal, screenshotUrl: ssUrl, status: 'Payment Review', createdAt: serverTimestamp(), grandTotalPaid: grandTotal });
                     });
                     await Promise.all(batchPromises);
                     showNotification("Order placed successfully!", "success");
                     onConfirm(); onClose();
                 } catch (e) { setError("Failed to place order. Please try again."); } finally { setUploading(false); }
             };

             return (
                 <Modal isOpen={true} onClose={onClose} title="Secure Checkout" maxWidth="max-w-5xl">
                     <div className="flex flex-col lg:flex-row gap-8">
                         <div className="flex-1 space-y-6">
                            <Input label="Full Name" placeholder="Receiver Name" value={delivery.name} onChange={e => setDelivery({...delivery, name: e.target.value})} />
                            <Input label="Street Address" placeholder="House No, Building, Area" value={delivery.address} onChange={e => setDelivery({...delivery, address: e.target.value})} />
                            <div className="grid grid-cols-2 gap-4"><Input label="State" placeholder="State" value={delivery.state} onChange={e => setDelivery({...delivery, state: e.target.value})} /><Input label="Zip Code" placeholder="000000" value={delivery.zip} onChange={e => setDelivery({...delivery, zip: e.target.value})} /></div>
                         </div>
                         <div className="w-full lg:w-96 bg-stone-50 p-8 rounded-[2rem] border border-stone-200 flex flex-col h-fit">
                             <div className="space-y-3 mb-6 pb-6 border-b border-stone-200 text-sm">
                                 <div className="flex justify-between text-stone-600"><span>Subtotal</span><span>{formatINR(subtotal)}</span></div>
                                 <div className="flex justify-between text-stone-600"><span>Delivery Fee</span><span>{formatINR(deliveryFee)}</span></div>
                                 <div className="flex justify-between text-xl font-black text-emerald-800 pt-2"><span>Total</span><span>{formatINR(grandTotal)}</span></div>
                             </div>
                             {adminPaymentSettings?.qrCodeUrl ? (
                                 <div className="text-center mb-6 bg-white p-4 rounded-2xl shadow-sm border border-stone-200">
                                     <img src={adminPaymentSettings.qrCodeUrl} className="w-48 h-48 object-contain mx-auto rounded-lg" alt="Payment QR" />
                                     <p className="mt-2 font-mono text-xs">{adminPaymentSettings.upiId}</p>
                                 </div>
                             ) : <div className="text-sm text-stone-400 text-center py-10 bg-white rounded-xl mb-6 border border-dashed border-stone-300">No QR Code Configured</div>}
                             <div className="mb-6"><label className="block text-xs font-bold text-stone-500 uppercase mb-2 ml-1">Upload Payment Screenshot</label><input type="file" onChange={e => setScreenshot(e.target.files[0])} className="block w-full text-sm text-stone-500 border border-stone-200 rounded-xl bg-white" /></div>
                             <Button onClick={handleConfirm} disabled={uploading} variant="primary" size="lg" className="w-full shadow-xl">{uploading ? "Verifying..." : "Confirm Payment"}</Button>
                         </div>
                     </div>
                 </Modal>
             );
          };

        const DeliveryDashboard = ({ }) => {
            const { currentUser, showNotification, handleLogout } = useGlobalState();
            const [tab, setTab] = useState('available');
            const [orders, setOrders] = useState([]);
            const [vehicleForm, setVehicleForm] = useState({ name: currentUser.vehicleName || '', number: currentUser.vehicleNumber || '' });
            const [loadingAction, setLoadingAction] = useState(false);
            
            useEffect(() => {
                let q;
                if (tab === 'available') q = query(getCollection("orders"), where("status", "==", "Ready for Pickup"));
                else q = query(getCollection("orders"), where("deliveryGuyId", "==", currentUser.uid));
                const unsubscribe = onSnapshot(q, snap => {
                    const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    if(tab === 'available') setOrders(data.filter(o => !o.deliveryGuyId));
                    else setOrders(data.sort((a,b) => (a.status === 'Delivered' ? 1 : -1)));
                });
                return () => unsubscribe();
            }, [tab, currentUser.uid]);

            const acceptOrder = async (id) => {
                setLoadingAction(true);
                try { await updateDoc(getDocRef("orders", id), { status: 'Out for Delivery', deliveryGuyId: currentUser.uid, deliveryGuyName: currentUser.name }); showNotification("Order Accepted!", "success"); setTab('my_jobs'); } catch(e) { showNotification("Error accepting order.", "error"); } finally { setLoadingAction(false); }
            };

            const markDelivered = async (id) => {
                try { await updateDoc(getDocRef("orders", id), { status: 'Delivered' }); showNotification("Order delivered successfully.", "success"); } catch(e) { showNotification("Update failed", "error"); }
            };

            const updateVehicle = async (e) => {
                  e.preventDefault();
                  try { await updateDoc(getDocRef("users", currentUser.uid), { vehicleName: vehicleForm.name, vehicleNumber: vehicleForm.number }); showNotification("Vehicle updated.", "success"); } catch (e) { showNotification("Update failed.", "error"); }
            };
            
            if(currentUser.status === 'suspended') return <div className="min-h-screen flex flex-col items-center justify-center"><h1 className="text-4xl font-bold">Suspended</h1><p>Too many rejections.</p><Button onClick={() => window.location.reload()} variant="dark">Refresh</Button></div>;
            if (currentUser.status === 'pending') return <div className="min-h-screen flex items-center justify-center"><div className="text-center"><h1 className="text-3xl font-bold">Verification Pending</h1><Button onClick={handleLogout} variant="secondary">Log Out</Button></div></div>;
            if (currentUser.status === 'rejected') return <div className="min-h-screen flex items-center justify-center"><div className="text-center"><h1 className="text-3xl font-bold">Rejected</h1><p>{currentUser.rejectionReason}</p><Button onClick={handleLogout} variant="dark">Sign Out</Button></div></div>;

            return (
                <div className="min-h-screen pt-28 px-4 bg-stone-50">
                    <div className="max-w-5xl mx-auto">
                        <div className="mb-10 flex flex-col md:flex-row justify-between items-end gap-6">
                            <div><h1 className="text-4xl font-display font-black text-stone-900 mb-2">Delivery Hub</h1></div>
                            <div className="flex gap-2 bg-white p-1.5 rounded-2xl shadow-sm border border-stone-200">
                                {['available', 'my_jobs', 'profile'].map(t => (<button key={t} onClick={() => setTab(t)} className={`px-6 py-2.5 rounded-xl font-bold text-xs capitalize transition-all duration-300 ${tab === t ? 'bg-stone-900 text-white shadow-lg' : 'text-stone-500 hover:text-stone-800'}`}>{t === 'available' ? 'Available' : t.replace('_', ' ')}</button>))}
                            </div>
                        </div>
                        <div className="grid gap-6 animate-in slide-up">
                            {tab === 'available' && (orders.length === 0 ? <div className="text-center py-24 bg-white rounded-[2.5rem] border border-dashed border-stone-200">No orders nearby</div> : 
                                    <div className="grid md:grid-cols-2 gap-6">{orders.map(order => (
                                            <div key={order.id} className="bg-white p-8 rounded-[2rem] shadow-xl relative overflow-hidden">
                                                <div className="flex justify-between items-start mb-6"><StatusBadge status="Ready for Pickup"/><span className="font-mono text-xs text-stone-400">#{order.id.slice(0,6)}</span></div>
                                                <div className="space-y-4 mb-8">
                                                    <div><p className="text-[10px] font-bold text-stone-400 uppercase">Pickup</p><p className="font-bold text-stone-900">{order.items?.[0]?.farmerName}</p></div>
                                                    <div><p className="text-[10px] font-bold text-stone-400 uppercase">Deliver To</p><p className="font-bold text-stone-900">{order.delivery.address}</p></div>
                                                </div>
                                                <Button onClick={() => acceptOrder(order.id)} variant="primary" size="lg" disabled={loadingAction} className="w-full">Accept</Button>
                                            </div>
                                    ))}</div>
                            )}
                            {tab === 'my_jobs' && (
                                <div className="space-y-8">
                                    {orders.filter(o => o.status === 'Out for Delivery').map(o => (
                                          <div key={o.id} className="bg-stone-900 text-white p-8 rounded-[3rem] shadow-2xl relative overflow-hidden">
                                              <div className="grid md:grid-cols-2 gap-6 mb-10">
                                                  <div className="bg-white/5 p-6 rounded-3xl"><h4 className="font-bold text-emerald-400 mb-4 text-xs uppercase">Customer</h4><p className="text-xl font-bold">{o.delivery.name}</p><p className="text-stone-400">{o.delivery.phone}</p></div>
                                                  <div className="bg-white/5 p-6 rounded-3xl"><h4 className="font-bold text-orange-400 mb-4 text-xs uppercase">Drop-off</h4><p className="text-xl font-bold">{o.delivery.address}</p></div>
                                              </div>
                                              <Button onClick={() => markDelivered(o.id)} variant="primary" size="lg" className="w-full bg-gradient-to-r from-emerald-500 to-green-600 h-16 text-xl">Swipe to Complete</Button>
                                          </div>
                                    ))}
                                    {orders.filter(o => o.status === 'Delivered').length > 0 && (
                                        <div className="animate-in slide-up">
                                            <h3 className="font-bold text-xl text-stone-900 mb-6">Completed Jobs</h3>
                                            <div className="grid gap-4">{orders.filter(o => o.status === 'Delivered').map(order => (
                                                    <div key={order.id} className="bg-white p-5 rounded-2xl flex justify-between items-center shadow-sm">
                                                        <div><p className="font-bold text-stone-900">Order #{order.id.slice(0,6)}</p><p className="text-xs text-stone-500">{new Date(order.createdAt?.seconds * 1000).toLocaleDateString()}</p></div>
                                                        <span className="text-emerald-600 font-black">+ {Math.floor(order.total * 0.15)}</span>
                                                    </div>
                                            ))}</div>
                                        </div>
                                    )}
                                </div>
                            )}
                            {tab === 'profile' && (
                                  <div className="max-w-lg mx-auto bg-white p-8 rounded-[2.5rem] shadow-xl border border-stone-100 animate-in fade-in">
                                      <h3 className="font-bold text-2xl text-stone-900 text-center mb-6">{currentUser.name}</h3>
                                      <form onSubmit={updateVehicle} className="space-y-6">
                                          <Input label="Vehicle Model" value={vehicleForm.name} onChange={e => setVehicleForm({...vehicleForm, name: e.target.value})} />
                                          <Input label="Registration Number" value={vehicleForm.number} onChange={e => setVehicleForm({...vehicleForm, number: e.target.value})} />
                                          <Button type="submit" variant="dark" className="w-full" disabled={loadingAction}>Save Changes</Button>
                                      </form>
                                  </div>
                              )}
                        </div>
                    </div>
                </div>
            );
        };

        const FarmerDashboard = () => {
            const { currentUser, showNotification, handleLogout } = useGlobalState();
            const [tab, setTab] = useState('inventory');
            const [myOrders, setMyOrders] = useState([]);
            const [products, setProducts] = useState([]);
            const [loadingAction, setLoadingAction] = useState(false);
            const [newProd, setNewProd] = useState({ name: '', price: '', stock: '', unit: 'kg', pesticides: false, description: '', farmAddress: '', state: '' });
            const [prodFile, setProdFile] = useState(null);
            const [editingId, setEditingId] = useState(null);

            useEffect(() => {
                const q = query(getCollection("products"), where("farmerId", "==", currentUser.uid));
                const unsubscribe = onSnapshot(q, (snapshot) => { setProducts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); });
                return () => unsubscribe();
            }, [currentUser.uid]);

            useEffect(() => {
                if (tab === 'orders') {
                    const q = query(getCollection("orders"), where("farmerId", "==", currentUser.uid), orderBy("createdAt", "desc"));
                    const unsubscribe = onSnapshot(q, (snapshot) => { setMyOrders(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); });
                    return () => unsubscribe();
                }
            }, [tab, currentUser.uid]);

            const handleSaveProduct = async (e) => {
                e.preventDefault();
                setLoadingAction(true);
                try {
                    let imageUrl = newProd.imageUrl || "https://images.unsplash.com/photo-1595855709915-445676396827?auto=format&fit=crop&q=80"; 
                    if (prodFile) imageUrl = await uploadToCloudinary(prodFile);
                    const productData = { ...newProd, imageUrl, farmerId: currentUser.uid, farmerName: currentUser.name, status: 'pending', updatedAt: serverTimestamp() };
                    if (editingId) { await updateDoc(getDocRef("products", editingId), productData); showNotification("Product updated!", "success"); } 
                    else { productData.createdAt = serverTimestamp(); await addDoc(getCollection("products"), productData); showNotification("Product added!", "success"); }
                    setNewProd({ name: '', price: '', stock: '', unit: 'kg', pesticides: false, description: '', farmAddress: '', state: '' });
                    setProdFile(null); setEditingId(null);
                } catch (error) { showNotification("Failed to save product.", "error"); } finally { setLoadingAction(false); }
            };

            const handleDeleteProduct = async (id) => { try { await deleteDoc(getDocRef("products", id)); showNotification("Product removed.", "success"); } catch (error) { showNotification("Deletion failed.", "error"); } };
            const handleOrderAction = async (orderId, status) => { try { await updateDoc(getDocRef("orders", orderId), { status }); showNotification("Status updated", "success"); } catch (e) { showNotification("Action failed.", "error"); } };
            const handleEditInit = (product) => { setNewProd(product); setEditingId(product.id); setProdFile(null); window.scrollTo({ top: 0, behavior: 'smooth' }); };

            if (currentUser.status === 'rejected') return <div className="min-h-screen flex items-center justify-center"><h1 className="text-3xl font-bold">Account Rejected</h1><Button onClick={handleLogout} variant="dark">Sign Out</Button></div>;
            if (currentUser.status === 'pending') return <div className="min-h-screen flex items-center justify-center"><h1 className="text-3xl font-bold">Verification Pending</h1><Button onClick={handleLogout} variant="secondary">Log Out</Button></div>;

            return (
                <div className="min-h-screen pt-28 pb-12 px-4 bg-stone-50">
                    <div className="max-w-6xl mx-auto">
                        <div className="mb-10 flex flex-col md:flex-row justify-between items-end gap-6">
                            <div><h1 className="text-4xl font-display font-black text-stone-900 tracking-tight">Farmer Dashboard</h1></div>
                            <div className="flex bg-white p-1.5 rounded-2xl shadow-sm border border-stone-100"><button onClick={() => setTab('inventory')} className={`px-6 py-2.5 rounded-xl font-bold text-sm ${tab === 'inventory' ? 'bg-stone-900 text-white' : 'text-stone-500'}`}>Inventory</button><button onClick={() => setTab('orders')} className={`px-6 py-2.5 rounded-xl font-bold text-sm ${tab === 'orders' ? 'bg-stone-900 text-white' : 'text-stone-500'}`}>Orders</button></div>
                        </div>
                        {tab === 'inventory' && (
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div className="lg:col-span-1">
                                    <div className="bg-white p-8 rounded-[2rem] shadow-xl border border-stone-100 sticky top-28">
                                        <h3 className="text-xl font-bold text-stone-900 mb-6">{editingId ? 'Edit Product' : 'Add Harvest'}</h3>
                                        <form className="space-y-4" onSubmit={handleSaveProduct}>
                                            <Input required placeholder="Product Name" value={newProd.name} onChange={e => setNewProd({...newProd, name: e.target.value})} />
                                            <div className="grid grid-cols-2 gap-4"><Input required type="number" placeholder="Price ()" value={newProd.price} onChange={e => setNewProd({...newProd, price: Number(e.target.value)})} /><Select value={newProd.unit} onChange={e => setNewProd({...newProd, unit: e.target.value})} options={[{value: 'kg', label: 'Per Kg'}, {value: 'bunch', label: 'Per Bunch'}, {value: 'piece', label: 'Per Piece'}]} /></div>
                                            <Input required type="number" placeholder="Stock Qty" value={newProd.stock} onChange={e => setNewProd({...newProd, stock: Number(e.target.value)})} />
                                            <div className={`flex items-center gap-3 p-4 rounded-xl cursor-pointer border ${newProd.pesticides ? 'bg-emerald-50 border-emerald-200' : 'bg-stone-50 border-stone-200'}`} onClick={() => setNewProd({...newProd, pesticides: !newProd.pesticides})}><div className={`w-5 h-5 rounded border flex items-center justify-center ${newProd.pesticides ? 'bg-emerald-600 border-emerald-600' : 'bg-white border-stone-300'}`}>{newProd.pesticides && <CheckCircle className="w-3.5 h-3.5 text-white" />}</div><span className="text-sm font-bold">Organic?</span></div>
                                            <Textarea placeholder="Description..." value={newProd.description} onChange={e => setNewProd({...newProd, description: e.target.value})} />
                                            <div className="border-2 border-dashed border-stone-200 rounded-2xl p-4 text-center cursor-pointer relative"><span className="text-sm font-bold text-stone-500">{prodFile ? prodFile.name : (newProd.imageUrl ? "Change Image" : "Upload Image")}</span><input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={(e) => setProdFile(e.target.files[0])} /></div>
                                            <Button type="submit" disabled={loadingAction} className="w-full" size="lg">{loadingAction ? <Spinner className="text-white"/> : (editingId ? 'Update' : 'Submit')}</Button>
                                        </form>
                                    </div>
                                </div>
                                <div className="lg:col-span-2 space-y-4">
                                    {products.map(p => (
                                        <div key={p.id} className="better-box p-5 flex flex-col sm:flex-row items-center gap-6 bg-white">
                                            <img src={p.imageUrl} className="w-full sm:w-24 h-24 rounded-2xl object-cover bg-stone-100" />
                                            <div className="flex-1 text-center sm:text-left"><div className="flex items-center gap-3 mb-2"><h4 className="text-xl font-bold">{p.name}</h4><StatusBadge status={p.status}/></div><div className="flex items-center gap-4 text-sm text-stone-500"><span>{p.stock} {p.unit}</span><span>{p.price}</span></div></div>
                                            <div className="flex gap-2"><button onClick={() => handleEditInit(p)} className="p-3 bg-stone-100 rounded-xl"><Edit2 className="w-5 h-5"/></button><button onClick={() => handleDeleteProduct(p.id)} className="p-3 bg-red-50 text-red-600 rounded-xl"><Trash2 className="w-5 h-5"/></button></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        {tab === 'orders' && (
                            <div className="space-y-6">
                                {myOrders.map(order => (
                                    <div key={order.id} className="better-box p-8 border-l-4 border-l-stone-900 bg-white">
                                        <div className="flex justify-between items-start mb-6 border-b border-stone-100 pb-4"><div><h4 className="font-bold text-xl">Order #{order.id.slice(0,6)}</h4><div className="mt-2"><StatusBadge status={order.status}/></div></div><div className="text-right"><span className="block text-xs font-bold text-stone-400">Earnings</span><span className="text-2xl font-black">{formatINR(order.total)}</span></div></div>
                                        <div className="space-y-3 mb-6 bg-stone-50 p-4 rounded-xl">{(order.items || []).map((item, idx) => (<div key={idx} className="flex justify-between text-sm"><span className="font-bold">{item.name} x{item.quantity}</span><span className="font-bold">{formatINR(item.price * item.quantity)}</span></div>))}</div>
                                        <div className="mt-6 pt-6 border-t border-stone-100">
                                            {order.status === 'Payment Verified' && <div className="flex gap-4"><Button onClick={() => handleOrderAction(order.id, 'Preparing')} variant="primary" size="lg" className="flex-1">Accept</Button><Button onClick={() => handleOrderAction(order.id, 'Rejected')} variant="danger" size="lg">Reject</Button></div>}
                                            {order.status === 'Preparing' && <Button onClick={() => handleOrderAction(order.id, 'Ready for Pickup')} variant="primary" size="lg" className="w-full">Mark Ready for Pickup</Button>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ModDashboard = () => {
            const { showNotification } = useGlobalState();
            const [activeTab, setActiveTab] = useState('users'); 
            const [pendingUsers, setPendingUsers] = useState([]);
            const [allProducts, setAllProducts] = useState([]); 
            const [allOrders, setAllOrders] = useState([]); 
            const [paymentSettings, setPaymentSettings] = useState({ qrCodeUrl: "", upiId: "" });
            const [qrFile, setQrFile] = useState(null);
            const [rejectReason, setRejectReason] = useState("");
            const [productRejectReason, setProductRejectReason] = useState("");
            const [savingSettings, setSavingSettings] = useState(false);
            const [selectedUserReject, setSelectedUserReject] = useState(null);
            const [selectedProductReject, setSelectedProductReject] = useState(null);
            const [selectedOrderReview, setSelectedOrderReview] = useState(null);
            
            useEffect(() => {
                const unsubUsers = onSnapshot(query(getCollection("users"), where("status", "==", "pending")), snap => setPendingUsers(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsubProds = onSnapshot(query(getCollection("products")), snap => setAllProducts(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsubOrders = onSnapshot(query(getCollection("orders"), orderBy("createdAt", "desc")), snap => setAllOrders(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                getDoc(getDocRef("settings", "payment")).then(s => { if (s.exists()) setPaymentSettings(s.data()); });
                return () => { unsubUsers(); unsubProds(); unsubOrders(); };
            }, []);

            const handleSaveSettings = async (e) => {
                e.preventDefault(); setSavingSettings(true);
                try {
                    let url = paymentSettings.qrCodeUrl;
                    if (qrFile) url = await uploadToCloudinary(qrFile);
                    await setDoc(getDocRef("settings", "payment"), { ...paymentSettings, qrCodeUrl: url });
                    showNotification("Settings updated successfully.", "success");
                } catch (e) { showNotification("Failed to save settings.", "error"); } finally { setSavingSettings(false); }
            };

            const handleUserUpdate = async (id, data) => { try { await updateDoc(getDocRef("users", id), data); showNotification("User status updated.", "success"); } catch(e) { showNotification("Update failed.", "error"); } setSelectedUserReject(null); };
            const handleProductUpdate = async (id, data) => { try { await updateDoc(getDocRef("products", id), data); showNotification("Product status updated.", "success"); } catch(e) { showNotification("Update failed.", "error"); } setSelectedProductReject(null); };
            const handleProductDelete = async (id) => { try { await deleteDoc(getDocRef("products", id)); showNotification("Product deleted.", "success"); } catch(e) { showNotification("Delete failed.", "error"); } };
            const handleOrderVerification = async (id, status) => { try { await updateDoc(getDocRef("orders", id), { status }); showNotification(`Order ${status.split(' ')[1]}!`, "success"); setSelectedOrderReview(null); } catch(e) { showNotification("Verification action failed.", "error"); } };

            return (
              <div className="min-h-screen pt-28 pb-12 px-4 bg-stone-50">
                  <div className="max-w-6xl mx-auto">
                      <header className="mb-10 flex flex-col md:flex-row justify-between items-end gap-6">
                        <h1 className="text-4xl font-display font-black text-stone-900 tracking-tight">Admin Console</h1>
                        <div className="flex bg-white p-1.5 rounded-2xl shadow-sm border border-stone-100 overflow-x-auto no-scrollbar">{['users', 'products', 'orders', 'settings'].map(tab => (<button key={tab} onClick={() => setActiveTab(tab)} className={`px-5 py-2 rounded-xl font-bold text-xs capitalize whitespace-nowrap transition-all ${activeTab === tab ? 'bg-stone-900 text-white shadow-lg' : 'text-stone-500 hover:text-stone-800'}`}>{tab}</button>))}</div>
                      </header>
                      {activeTab === 'users' && (
                          <div className="space-y-4 animate-in fade-in">
                              {pendingUsers.map(user => (
                                  <div key={user.id} className="better-box p-6 flex flex-col md:flex-row justify-between items-center gap-6 bg-white">
                                      <div className="flex-1"><h4 className="font-bold text-lg">{user.name} <span className="bg-stone-100 text-stone-600 text-xs px-2 py-1 rounded-lg">{user.role}</span></h4><p className="text-sm text-stone-500">{user.email}</p></div>
                                      <div className="flex gap-3 w-full md:w-auto"><Button onClick={() => handleUserUpdate(user.id, {status: 'active'})} variant="primary" size="sm">Approve</Button><Button onClick={() => setSelectedUserReject(user.id)} variant="danger" size="sm">Reject</Button></div>
                                  </div>
                              ))}
                          </div>
                      )}
                      {activeTab === 'products' && (
                          <div className="space-y-12 animate-in fade-in">
                              <div>
                                  <h3 className="text-xl font-bold mb-6">Pending Approval</h3>
                                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">{allProducts.filter(p => p.status === 'pending').map(p => (<div key={p.id} className="better-box p-5 border-l-4 border-l-amber-400 bg-white"><div className="flex gap-4 mb-4"><img src={p.imageUrl} className="w-20 h-20 rounded-xl object-cover"/><div className="flex-1"><h4 className="font-bold">{p.name}</h4><p className="text-xs text-stone-500">{p.farmerName}</p></div></div><div className="flex gap-2"><Button onClick={() => handleProductUpdate(p.id, {status: 'approved'})} variant="primary" size="sm" className="flex-1">Approve</Button><Button onClick={() => setSelectedProductReject(p.id)} variant="danger" size="sm" className="flex-1">Reject</Button></div></div>))}</div>
                              </div>
                              <div>
                                  <h3 className="text-xl font-bold mb-6">Live Inventory</h3>
                                  <div className="grid grid-cols-1 md:grid-cols-3 gap-6">{allProducts.filter(p => p.status === 'approved').map(p => (<div key={p.id} className="better-box p-4 bg-white"><div className="flex gap-3 mb-4"><img src={p.imageUrl} className="w-12 h-12 rounded-lg object-cover"/><div className="min-w-0"><h4 className="font-bold text-sm truncate">{p.name}</h4><p className="text-xs text-stone-500 truncate">{p.farmerName}</p></div></div><Button onClick={() => handleProductDelete(p.id)} variant="danger" size="sm" className="w-full">Delete</Button></div>))}</div>
                              </div>
                          </div>
                      )}
                      {activeTab === 'orders' && (
                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-in fade-in">
                              {allOrders.map(order => (
                                  <div key={order.id} onClick={() => setSelectedOrderReview(order)} className="better-box p-6 cursor-pointer bg-white relative group">
                                      {order.status === 'Payment Review' && <span className="absolute top-4 right-4 w-3 h-3 bg-amber-500 rounded-full animate-pulse"></span>}
                                      <div className="flex justify-between items-start mb-3"><span className="text-xs font-mono">#{order.id.slice(0,6)}</span><StatusBadge status={order.status}/></div>
                                      <h4 className="font-bold text-lg mb-1">{order.delivery?.name || 'Unknown'}</h4>
                                      <p className="text-2xl font-black">{formatINR(order.total)}</p>
                                  </div>
                              ))}
                          </div>
                      )}
                      {activeTab === 'settings' && (
                          <div className="max-w-md mx-auto better-box p-10 bg-white animate-in slide-up">
                              <h2 className="text-2xl font-bold mb-6">Payment Configuration</h2>
                              <form onSubmit={handleSaveSettings} className="space-y-6">
                                  <Input label="Merchant UPI ID" value={paymentSettings.upiId} onChange={e => setPaymentSettings({...paymentSettings, upiId: e.target.value})} placeholder="merchant@upi" />
                                  <div className="border-2 border-dashed p-8 text-center rounded-2xl cursor-pointer relative"><p className="text-sm font-bold">{qrFile ? qrFile.name : "Upload New QR Code"}</p><input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={e => setQrFile(e.target.files[0])} /></div>
                                  <Button type="submit" disabled={savingSettings} variant="dark" className="w-full">{savingSettings ? "Saving..." : "Save Configuration"}</Button>
                              </form>
                          </div>
                      )}
                      <Modal isOpen={!!selectedUserReject} onClose={() => setSelectedUserReject(null)} title="Reject"><textarea className="input-better h-32 mb-4" placeholder="Reason..." value={rejectReason} onChange={e => setRejectReason(e.target.value)}/><Button onClick={() => handleUserUpdate(selectedUserReject, {status:'rejected', rejectionReason:rejectReason})} variant="dangerSolid" fullWidth>Confirm</Button></Modal>
                      <Modal isOpen={!!selectedProductReject} onClose={() => setSelectedProductReject(null)} title="Reject"><textarea className="input-better h-32 mb-4" placeholder="Reason..." value={productRejectReason} onChange={e => setProductRejectReason(e.target.value)}/><Button onClick={() => handleProductUpdate(selectedProductReject, {status:'rejected', rejectionReason:productRejectReason})} variant="dangerSolid" fullWidth>Confirm</Button></Modal>
                      {selectedOrderReview && (
                          <Modal isOpen={true} onClose={() => setSelectedOrderReview(null)} title="Order Verification" maxWidth="max-w-2xl">
                              <div className="flex flex-col md:flex-row gap-8">
                                  <div className="flex-1 space-y-4">
                                      <div className="bg-stone-50 p-4 rounded-xl"><p className="text-xs font-bold uppercase mb-1">Status</p><StatusBadge status={selectedOrderReview.status}/></div>
                                      <div className="bg-stone-50 p-4 rounded-xl"><p className="text-xs font-bold uppercase mb-1">Customer</p><p className="font-bold">{selectedOrderReview.delivery?.name}</p></div>
                                      <div className="bg-stone-50 p-4 rounded-xl"><p className="text-xs font-bold uppercase mb-1">Amount</p><p className="text-3xl font-black text-emerald-700">{formatINR(selectedOrderReview.grandTotalPaid || selectedOrderReview.total)}</p></div>
                                  </div>
                                  <div className="flex-1">
                                      {selectedOrderReview.screenshotUrl ? <a href={selectedOrderReview.screenshotUrl} target="_blank" className="block mb-6"><img src={selectedOrderReview.screenshotUrl} className="w-full h-64 object-cover rounded-xl border" /></a> : <div className="h-64 bg-stone-100 rounded-xl flex items-center justify-center text-stone-400">No Screenshot</div>}
                                      {selectedOrderReview.status === 'Payment Review' && <div className="grid grid-cols-2 gap-3"><Button onClick={() => handleOrderVerification(selectedOrderReview.id, 'Payment Verified')} variant="primary">Confirm</Button><Button onClick={() => handleOrderVerification(selectedOrderReview.id, 'Payment Rejected')} variant="danger">Reject</Button></div>}
                                  </div>
                              </div>
                          </Modal>
                      )}
                  </div>
              </div>
            );
          };

        const MainContent = () => {
            const { view, currentUser, loading, authMode, setAuthMode, showNotification, setView } = useGlobalState();
            
            const handleLogin = async (email, password) => {
                try { await signInWithEmailAndPassword(auth, email, password); showNotification("Welcome back!", "success"); } 
                catch(e) { showNotification("Invalid email or password.", "error"); }
            };
            
            const signupUser = async (data, file) => {
               try {
                  const cred = await createUserWithEmailAndPassword(auth, data.email, data.password);
                  let docUrl = "";
                  if (file) docUrl = await uploadToCloudinary(file);
                  let role = data.role;
                  let status = (role === 'farmer' || role === 'delivery') ? 'pending' : 'active';
                  if (MOD_EMAILS.includes(data.email.toLowerCase())) { role = 'mod'; status = 'active'; }
                  await setDoc(getDocRef("users", cred.user.uid), { ...data, role, status, docUrl, joinedDate: serverTimestamp(), rejectionCount: 0 });
                  showNotification("Account created successfully!", "success");
               } catch (e) { showNotification(e.message, "error"); }
            };

            if (loading) return <LoadingScreen />;

            return (
                <>
                    <Navbar />
                    <main className="flex-grow">
                        {view === 'home' && <Hero />}
                        {view === 'auth' && <AuthScreen authMode={authMode} setAuthMode={setAuthMode} handleLogin={handleLogin} handleSignup={signupUser} loading={false} />}
                        {view === 'farmer-panel' && currentUser?.role === 'farmer' && <FarmerDashboard />}
                        {view === 'delivery-panel' && currentUser?.role === 'delivery' && <DeliveryDashboard />}
                        {view === 'mod-panel' && currentUser?.role === 'mod' && <ModDashboard />}
                        {view === 'marketplace' && <Marketplace />}
                        {view === 'my-orders' && <BuyerOrders />}
                        {view === 'checkout' && <CheckoutModal onClose={() => setView('home')} onConfirm={() => setView('my-orders')} />}
                        {view === 'about' && (
                            <div className="pt-40 px-4 max-w-4xl mx-auto text-center animate-in slide-up">
                                <h1 className="text-5xl font-display font-black mb-8 text-stone-900">Empowering Farmers,<br/>Nourishing Communities</h1>
                                <p className="text-xl text-stone-600 leading-relaxed">At Farm2Home, we are dedicated to revolutionizing the agricultural landscape.</p>
                            </div>
                        )}
                    </main>
                    {['home', 'marketplace', 'about'].includes(view) && <Footer />}
                </>
            );
        };

        const App = () => {
            return (
                <AppProvider>
                    <div className="font-sans text-stone-900 min-h-screen flex flex-col">
                        <MainContent />
                    </div>
                </AppProvider>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
